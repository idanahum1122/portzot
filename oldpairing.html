<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>פורצות דרך | חיבור לשותפות</title>

<style>
:root{
  --bg:#0a0e1a;
  --card:rgba(255,255,255,.06);
  --border:rgba(255,255,255,.12);
  --text:#f8fafc;
  --muted:#c7d2fe;
  --accent:#ff3b9a;
  --accent2:#8b5cf6;
  --accent3:#06b6d4;
  --radius:20px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Inter','Segoe UI','Helvetica Neue',Arial,sans-serif;
  background:linear-gradient(135deg,#0a0e1a 0%,#1a1332 50%,#0f0a1e 100%);
  background-attachment:fixed;
  color:var(--text);
  overflow-x:hidden;
}

body::before{
  content:'';
  position:fixed;
  top:-50%;
  left:-50%;
  width:200%;
  height:200%;
  background:radial-gradient(circle,rgba(255,59,154,.08) 0%,transparent 50%);
  animation:float 20s ease-in-out infinite;
  z-index:0;
  pointer-events:none;
}

@keyframes float{
  0%,100%{transform:translate(0,0) rotate(0deg)}
  50%{transform:translate(30px,-30px) rotate(180deg)}
}

.container{
  max-width:680px;
  margin:auto;
  padding:32px 20px;
  padding-top:100px;
  position:relative;
  z-index:1;
}

#instructorBar{
  position:fixed;
  top:0;left:0;right:0;
  background:rgba(10,14,26,.95);
  border-bottom:1px solid rgba(255,59,154,.2);
  box-shadow:0 4px 20px rgba(255,59,154,.1);
  z-index:100;
  backdrop-filter:blur(20px);
}
#instructorBar .inner{
  max-width:680px;
  margin:auto;
  padding:12px 20px;
  display:flex;
  gap:12px;
  align-items:center;
  flex-wrap:wrap;
}
#instructorBar label{
  margin:0;
  font-size:11px;
  color:var(--muted);
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
#instructorBar label::before{content:none}
#instructorBar input{
  padding:10px 12px;
  font-size:14px;
  width:120px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(0,0,0,.4);
  color:var(--text);
  outline:none;
  transition:.3s;
}
#instructorBar input:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(255,59,154,.1);
}
#instructorBar button{
  margin:0;
  padding:10px 18px;
  font-size:13px;
  width:auto;
  border:none;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
  color:white;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  transition:.3s;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
#instructorBar button:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(255,59,154,.3);
}
#instructorBar .status{
  margin-right:auto;
  font-size:12px;
  color:rgba(248,250,252,.9);
  font-weight:500;
}

.card{
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius);
  padding:32px 28px;
  margin-bottom:24px;
  backdrop-filter:blur(10px);
  box-shadow:0 8px 32px rgba(0,0,0,.2);
  transition:.3s;
}
.card:hover{
  border-color:rgba(255,59,154,.2);
  box-shadow:0 12px 40px rgba(255,59,154,.15);
}

h1{
  margin:0 0 16px;
  font-size:32px;
  font-weight:900;
  background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  letter-spacing:-0.5px;
}
h2{
  margin:0 0 12px;
  font-size:22px;
  font-weight:800;
  color:var(--text);
  letter-spacing:-0.3px;
}
p{
  color:var(--muted);
  line-height:1.8;
  margin:0 0 14px;
  font-size:15px;
}

button.primary{
  width:100%;
  margin-top:24px;
  padding:16px;
  border:none;
  border-radius:14px;
  font-weight:800;
  font-size:15px;
  cursor:pointer;
  color:white;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  transition:.3s;
  text-transform:uppercase;
  letter-spacing:1px;
  box-shadow:0 8px 24px rgba(255,59,154,.3);
}
button.primary:hover{
  transform:translateY(-3px);
  box-shadow:0 12px 32px rgba(255,59,154,.4);
}
button.primary:active{
  transform:translateY(-1px);
}

button.start-compact{
  width:auto;
  display:inline-block;
  padding:14px 32px;
  border-radius:999px;
  font-size:16px;
  font-weight:900;
  margin:20px auto 0;
}

@keyframes softAppear{
  from{opacity:0;transform:translateY(12px) scale(.95)}
  to{opacity:1;transform:translateY(0) scale(1)}
}
.start-animate{animation:softAppear .7s cubic-bezier(.34,1.56,.64,1) both;}

button.secondary{
  width:100%;
  margin-top:16px;
  padding:16px;
  border-radius:14px;
  font-weight:700;
  font-size:14px;
  cursor:pointer;
  color:var(--text);
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.15);
  transition:.3s;
}
button.secondary:hover{
  background:rgba(255,255,255,.08);
  border-color:var(--accent);
  transform:translateY(-2px);
}

.hidden{display:none}

.quote{
  margin:20px 0;
  padding:20px;
  border-radius:16px;
  background:linear-gradient(135deg,rgba(255,59,154,.1),rgba(139,92,246,.1));
  border:1px solid rgba(255,59,154,.2);
  font-weight:600;
  text-align:center;
  font-size:16px;
  line-height:1.6;
  color:var(--text);
}

.intro-note{
  margin:20px 0;
  padding:20px;
  border-radius:16px;
  background:rgba(6,182,212,.08);
  border:1px solid rgba(6,182,212,.2);
}
.intro-note p{
  margin:0 0 12px;
  color:rgba(248,250,252,.95);
  font-weight:500;
}
.intro-note ul{
  margin:0;
  padding:0 20px 0 0;
  color:var(--muted);
  line-height:1.9;
}
.intro-note li{
  margin:10px 0;
  font-weight:500;
}
.intro-note strong{
  color:var(--accent3);
  font-weight:700;
}

label{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:32px;
  color:#f1f5ff;
  font-weight:700;
  font-size:15px;
}
label::before{
  content:"✨";
  font-size:20px;
  opacity:.9;
}
#instructorBar label{margin-top:0}
#instructorBar label::before{content:none}

input{
  width:100%;
  padding:14px 16px;
  margin-top:10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.15);
  background:rgba(0,0,0,.3);
  color:#ffffff;
  font-size:15px;
  transition:.3s;
  font-weight:500;
}
input:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 4px rgba(255,59,154,.15);
  background:rgba(0,0,0,.4);
}

.choice-group{
  display:grid;
  grid-template-columns:1fr;
  gap:12px;
  margin-top:12px;
  margin-bottom:28px;
  padding-bottom:20px;
  border-bottom:1px solid rgba(255,255,255,.06);
}
.choice{
  padding:16px 18px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.03);
  cursor:pointer;
  font-weight:500;
  font-size:14px;
  transition:.3s;
  position:relative;
  overflow:hidden;
}
.choice::before{
  content:'';
  position:absolute;
  top:0;
  left:-100%;
  width:100%;
  height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,59,154,.1),transparent);
  transition:.5s;
}
.choice:hover::before{
  left:100%;
}
.choice:hover{
  background:rgba(255,255,255,.06);
  border-color:rgba(255,59,154,.3);
  transform:translateY(-2px);
}
.choice.active{
  background:linear-gradient(135deg,rgba(255,59,154,.25),rgba(139,92,246,.25));
  border-color:var(--accent);
  color:white;
  font-weight:700;
  box-shadow:0 4px 16px rgba(255,59,154,.3);
}
@media (min-width:520px){
  .choice-group{grid-template-columns:1fr 1fr}
}

.small-note{
  font-size:13px;
  color:rgba(199,210,254,.8);
  margin-top:12px;
  font-weight:500;
}

.wait-text{
  text-align:center;
  font-size:24px;
  font-weight:900;
  background:linear-gradient(135deg,#ff3b9a,#8b5cf6,#06b6d4);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  margin-top:24px;
  animation:pulse 2s ease-in-out infinite;
}

@keyframes pulse{
  0%,100%{opacity:1}
  50%{opacity:.6}
}

.thinking{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:20px;
  padding:40px 0;
}
@keyframes blink{
  0%,100%{opacity:.2;transform:scale(.8)}
  50%{opacity:1;transform:scale(1.2)}
}
.thinking-dots{
  display:flex;
  gap:12px;
}
.thinking-dots span{
  font-size:40px;
  color:#ff3b9a;
  animation:blink 1.4s infinite;
  filter:drop-shadow(0 0 10px rgba(255,59,154,.6));
}
.thinking-dots span:nth-child(2){animation-delay:.2s}
.thinking-dots span:nth-child(3){animation-delay:.4s}

.progress-big{
  font-size:56px;
  font-weight:900;
  background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  text-align:center;
  margin:32px 0;
  letter-spacing:-2px;
}
.progress-label{
  text-align:center;
  color:var(--muted);
  font-size:14px;
  margin-bottom:28px;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:1px;
}
</style>
</head>

<body>
<div id="instructorBar" class="hidden">
  <div class="inner">
    <label for="instructorCode">קוד מדריכה</label>
    <input id="instructorCode" type="password" inputmode="numeric" placeholder="••••" autocomplete="one-time-code">

    <label for="expectedCount" style="margin-right:8px">מס' משתתפות</label>
    <input id="expectedCount" inputmode="numeric" placeholder="18" style="width:90px">

    <button id="activateBtn" type="button">התחל פעילות</button>
    <div class="status" id="barStatus">הפעילות עדיין לא הופעלה</div>
  </div>
</div>

<div class="container">

  <button id="openInstructor" class="secondary" type="button" style="margin-bottom:12px">כניסת מדריכה</button>

  <div class="card" id="introScreen">
    <h1>בחירת שותפה לתהליך</h1>
    <div class="intro-note">
      <p><strong>הפעילות הזו אינה מבחן</strong> - ואין בה תשובות נכונות או לא נכונות.</p>
      <p>המטרה היא ליצור <strong>שותפות טובה</strong> לעבודה משותפת בתהליך התיכון ההנדסי.</p>
      <ul>
        <li><strong>היכרות</strong> - להבין מי את ואיך נוח לך לעבוד</li>
        <li><strong>אמון</strong> - להתחיל יחד בתחושה טובה ובטוחה</li>
        <li><strong>דיוק</strong> - לבחור שותפה שתעזור לכן להתקדם באמת</li>
      </ul>
    </div>

    <div class="quote">פורצת דרך מצליחה כשהיא צועדת קדימה עם נשים מצליחות כמוה.</div>

    <p class="wait-text" id="waitText"><strong>נא להמתין</strong></p>

    <div style="text-align:center">
      <button id="startBtn" class="primary start-compact hidden" type="button" style="display:none">מתחילות</button>
    </div>
  </div>

  <div class="card hidden" id="managementScreen">
    <h1>ניהול פעילות</h1>
    <p>מעקב אחר התקדמות המשתתפות בזמן אמת</p>
    
    <div class="progress-big" id="progressCount">0 / 0</div>
    <div class="progress-label">משתתפות שהשלימו את השאלון</div>
    
    <button id="generatePairsBtn" class="primary hidden" type="button">מחולל זוגות</button>
    
    <p class="small-note" id="managementNote" style="text-align:center;margin-top:20px">
      ממתינה שכל המשתתפות ישלימו את השאלון...
    </p>
  </div>

  <!-- שלב 1 -->
  <div class="card hidden" id="step1">
    <h2>לפני שמתחילות</h2>
    <label>שם פרטי / כינוי (כדי שתוכלי לזהות את עצמך במסך החיבורים)</label>
    <input id="displayName" placeholder="לדוגמה: נועה" maxlength="24">

    <h2 style="margin-top:32px">תחומי עניין</h2>
    <label>מה התחום המרכזי שבחרת לתהליך?</label>
    <div class="choice-group" data-field="mainDomain">
      <div class="choice">הייטק וליבה</div>
      <div class="choice">אדם וטכנולוגיה</div>
      <div class="choice">סביבה וקיימות</div>
      <div class="choice">עתיד ויזמות</div>
      <div class="choice">חברה ודיגיטל</div>
    </div>

    <label>האם יש תחום נוסף שמעניין אותך?</label>
    <div class="choice-group" data-field="secondDomain">
      <div class="choice">הייטק וליבה</div>
      <div class="choice">אדם וטכנולוגיה</div>
      <div class="choice">סביבה וקיימות</div>
      <div class="choice">עתיד ויזמות</div>
      <div class="choice">חברה ודיגיטל</div>
      <div class="choice">אני מעדיפה להתמקד בתחום אחד</div>
    </div>

    <button class="primary" type="button" onclick="next(2)">המשך</button>
  </div>

  <!-- שלב 2 -->
  <div class="card hidden" id="step2">
    <h2>איך את פועלת?</h2>
    
    <label>כשיש משימה חדשה ולא ברורה, את בדרך כלל:</label>
    <div class="choice-group" data-field="workStyle">
      <div class="choice">מתחילה להתנסות ולומדת תוך כדי התנסות</div>
      <div class="choice">עוצרת קודם להבין לעומק ולתכנן את הצעדים</div>
    </div>

    <label>כשאת עובדת עם שותפה על משימה:</label>
    <div class="choice-group" data-field="teamStyle">
      <div class="choice">אני חושבת בקול רם ומשתפת כל רעיון</div>
      <div class="choice">אני מעדיפה לעבוד בשקט ואז להציג את התוצאה</div>
    </div>

    <label>מהו קצב העבודה הטבעי שלך?</label>
    <div class="choice-group" data-field="workPace">
      <div class="choice">אני אוהבת לעבוד מהר ולסיים מוקדם</div>
      <div class="choice">אני מעדיפה לקחת זמן ולעשות בדיוק</div>
      <div class="choice">תלוי במשימה - אני גמישה</div>
    </div>

    <button class="primary" type="button" onclick="next(3)">המשך</button>
  </div>

  <!-- שלב 3 -->
  <div class="card hidden" id="step3">
    <h2>התפקיד שלך בצוות</h2>

    <label>באיזה תפקיד את הכי טובה בעבודת צוות?</label>
    <div class="choice-group" data-field="teamRole">
      <div class="choice">למצוא רעיונות מקוריים ולהתחיל דברים חדשים</div>
      <div class="choice">לארגן משימות ולוודא שהכל זורם בזמן</div>
      <div class="choice">לעזור לאחרות להבין ולהסביר מושגים מורכבים</div>
      <div class="choice">לפתור בעיות טכניות כשמשהו תקוע</div>
    </div>

    <label>מה עוזר לך להתמיד בפרויקט לאורך זמן?</label>
    <div class="choice-group" data-field="motivationSource">
      <div class="choice">תחושת משמעות - שאני עושה משהו חשוב</div>
      <div class="choice">אתגר אינטלקטואלי - פתרון בעיות מורכבות</div>
      <div class="choice">עבודת צוות - החיבור עם האנשים</div>
      <div class="choice">התוצאה הסופית - לראות את המוצר מוכן</div>
    </div>

    <button class="primary" type="button" onclick="next(4)">המשך</button>
  </div>

  <!-- שלב 4 -->
  <div class="card hidden" id="step4">
    <h2>תקשורת ופתרון בעיות</h2>

    <label>כשיש דדלין קרוב ואת מרגישה לחץ:</label>
    <div class="choice-group" data-field="pressureResponse">
      <div class="choice">אני פועלת הכי טוב תחת לחץ - זה מניע אותי</div>
      <div class="choice">אני צריכה לתכנן מראש כדי למנוע לחץ</div>
      <div class="choice">אני לוקחת הפסקה קצרה ואז חוזרת בכוח</div>
    </div>

    <label>כשיש אי-הסכמה עם השותפה שלך בנושא חשוב:</label>
    <div class="choice-group" data-field="conflictStyle">
      <div class="choice">עוצרת ומנסה להבין לעומק את הצד השני</div>
      <div class="choice">מציגה את העמדה שלי בבירור ומנסה לשכנע</div>
      <div class="choice">מחפשת פשרה שמשלבת את שני הצדדים</div>
    </div>

    <label>איך את הכי נוחה לתקשר עם השותפה בין המפגשים?</label>
    <div class="choice-group" data-field="communicationStyle">
      <div class="choice">פגישות פנים אל פנים בלבד</div>
      <div class="choice">שיחות וידאו או טלפון</div>
      <div class="choice">הודעות טקסט וקבצים משותפים</div>
      <div class="choice">לא משנה לי - אני גמישה</div>
    </div>

    <label>איזה תוכן באמת מושך אותך ביום-יום?</label>
    <div class="choice-group" data-field="lifeInterest">
      <div class="choice">טכנולוגיה, אפליקציות וחדשנות</div>
      <div class="choice">אנשים, פסיכולוגיה והשפעה חברתית</div>
      <div class="choice">סביבה, טבע וקיימות</div>
      <div class="choice">רעיונות, עתיד ותרבות</div>
    </div>

    <button class="primary" type="button" onclick="next(5)">המשך</button>
  </div>

  <!-- שלב 5 -->
  <div class="card hidden" id="step5">
    <h2>שאלה אחרונה</h2>

    <label>כמה חשוב לך להתאים עם השותפה שלך?</label>
    <div class="choice-group" data-field="importanceLevel">
      <div class="choice">מאוד חשוב - אני רוצה התאמה הכי טובה</div>
      <div class="choice">קצת חשוב - אבל אני יכולה להסתדר עם כולן</div>
      <div class="choice">לא כל כך חשוב - אני גמישה</div>
    </div>

    <button class="primary" type="button" onclick="finish()">סיימתי - מוכנה לשותפות</button>
  </div>

  <div class="card hidden" id="waiting">
    <h1>מחכות יחד</h1>
    <p>מעולה - הבחירות שלך נשמרו.</p>
    <p>כשהמדריכה תייצר את החיבורים, תראי כאן את תוצאת השותפות.</p>
  </div>

  <div class="card hidden" id="thinking">
    <div class="thinking">
      <h1>חושבות יחד</h1>
      <div class="thinking-dots"><span>•</span><span>•</span><span>•</span></div>
      <p class="small-note">מחפשות את השותפות המדויקת ביותר…</p>
    </div>
  </div>

  <div class="card hidden" id="pairing">
    <h1>מסך החיבורים</h1>
    <p>שותפות טובה נבנית משילוב של <strong>תחומי עניין משותפים</strong> ודרך עבודה משלימה.</p>
    <p class="small-note">זוהי מיומנות מרכזית בעולם ההייטק: לדעת לעבוד יחד, לחלוק אחריות, ולנוע קדימה כצוות.</p>
    <div id="pairingResult"></div>
    <button class="secondary" type="button" onclick="resetApp()">התחל פעילות חדשה</button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  doc,
  setDoc,
  onSnapshot,
  collection,
  getDocs,
  serverTimestamp,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCFSq5b-HgkTxFNhBJIBdOe2ian5TZvMPE",
  authDomain: "portzot-derech.firebaseapp.com",
  projectId: "portzot-derech"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const SESSION_ID = "active";
const sessionRef = doc(db, "sessions", SESSION_ID);
const responsesRef = collection(db, "responses");

const SESSION_DURATION_MS = 20 * 60 * 1000;
const DAY_MS = 24 * 60 * 60 * 1000;

const DEVICE_ID_KEY = "pd_pairing_device_id";
const deviceId = localStorage.getItem(DEVICE_ID_KEY) || crypto.randomUUID();
localStorage.setItem(DEVICE_ID_KEY, deviceId);

let isInstructor = localStorage.getItem('pd_is_instructor') === 'true';

const openInstructorBtn = document.getElementById('openInstructor');
const instructorBar = document.getElementById('instructorBar');
const startBtn = document.getElementById('startBtn');
const waitText = document.getElementById('waitText');

const activateBtn = document.getElementById('activateBtn');
const expectedCountInput = document.getElementById('expectedCount');
const instructorCode = document.getElementById('instructorCode');
const barStatus = document.getElementById('barStatus');

const displayName = document.getElementById('displayName');
const pairingResult = document.getElementById('pairingResult');

const managementScreen = document.getElementById('managementScreen');
const progressCount = document.getElementById('progressCount');
const managementNote = document.getElementById('managementNote');
const generatePairsBtn = document.getElementById('generatePairsBtn');

const selections = {};
document.querySelectorAll('.choice-group').forEach(group => {
  const field = group.dataset.field;
  group.querySelectorAll('.choice').forEach(ch => {
    ch.addEventListener('click', () => {
      group.querySelectorAll('.choice').forEach(c => c.classList.remove('active'));
      ch.classList.add('active');
      selections[field] = ch.textContent.trim();
    });
  });
});

function showOnly(id){
  document.querySelectorAll('.container .card').forEach(c => {
    c.classList.add('hidden');
  });
  
  const targetEl = document.getElementById(id);
  if(targetEl) targetEl.classList.remove('hidden');
}

function setStartEnabled(enabled){
  if(enabled){
    startBtn.style.display = 'inline-block';
    startBtn.classList.remove('hidden');
    startBtn.classList.remove('start-animate');
    requestAnimationFrame(() => startBtn.classList.add('start-animate'));
    waitText?.classList.add('hidden');
  } else {
    startBtn.style.display = 'none';
    startBtn.classList.add('hidden');
    waitText?.classList.remove('hidden');
  }
}

function resetToWaiting(){
  setStartEnabled(false);
  showOnly('introScreen');
}

resetToWaiting();

let currentSession = null;
let sessionEndsAt = 0;
let pairingShown = false;

async function countValidResponses(){
  const snap = await getDocs(responsesRef);
  const now = Date.now();
  let c = 0;
  snap.docs.forEach(d => {
    const x = d.data();
    if(x.sessionId === SESSION_ID && typeof x.createdAt === 'number' && (now - x.createdAt) <= DAY_MS){
      c++;
    }
  });
  return c;
}

function isActiveFromData(data){
  if(!data?.started || typeof data.startTime !== 'number') return false;
  return Date.now() < (data.startTime + SESSION_DURATION_MS);
}

async function updateManagementScreen(){
  const answersCount = await countValidResponses();
  const expected = Number(currentSession?.expectedCount || 0);
  
  progressCount.textContent = `${answersCount} / ${expected}`;
  
  if(expected > 0 && answersCount >= expected){
    generatePairsBtn.classList.remove('hidden');
    managementNote.textContent = "כל המשתתפות השלימו! ניתן ליצור זוגות.";
  } else {
    generatePairsBtn.classList.add('hidden');
    managementNote.textContent = `ממתינה ל-${expected - answersCount} משתתפות נוספות...`;
  }
}

onSnapshot(sessionRef, async (snap) => {
  pairingShown = false;

  if(!snap.exists()){
    currentSession = null;
    barStatus.textContent = "הפעילות עדיין לא הופעלה";
    
    if(!isInstructor){
      resetToWaiting();
      openInstructorBtn.classList.remove('hidden');
    }
    return;
  }

  const data = snap.data();
  currentSession = data;

  if(isActiveFromData(data)){
    sessionEndsAt = data.startTime + SESSION_DURATION_MS;

    const now = Date.now();
    const answersCount = await countValidResponses();
    const minsLeft = Math.max(0, Math.ceil((sessionEndsAt - now) / 60000));
    const expected = Number(data.expectedCount || 0);
    const progress = expected ? ` · ${answersCount}/${expected} תשובות` : '';

    barStatus.textContent = `פעיל עכשיו · נשארו בערך ${minsLeft} דק'${progress}`;
    
    openInstructorBtn.classList.add('hidden');
    
    if(isInstructor){
      showOnly('managementScreen');
      await updateManagementScreen();
    } else {
      setStartEnabled(true);
    }

    if(data.pairingReady){
      await showPairing();
    }
    return;
  }

  barStatus.textContent = "הפעילות עדיין לא הופעלה";
  if(!isInstructor){
    resetToWaiting();
    openInstructorBtn.classList.remove('hidden');
  }
});

setInterval(async () => {
  if(isInstructor && currentSession && isActiveFromData(currentSession)){
    await updateManagementScreen();
  }
}, 3000);

openInstructorBtn.addEventListener('click', () => {
  instructorBar.classList.remove('hidden');
  openInstructorBtn.classList.add('hidden');
  setTimeout(() => instructorCode?.focus(), 50);
});

activateBtn.addEventListener('click', async () => {
  const code = (instructorCode.value || '').trim();
  
  if(!code){
    barStatus.textContent = "נא להזין קוד מדריכה";
    return;
  }

  if(code !== '2311'){
    barStatus.textContent = "קוד לא תקין";
    return;
  }

  const expected = Number(expectedCountInput.value || 0);
  if(expected <= 0){
    barStatus.textContent = "נא להזין מספר משתתפות תקין";
    return;
  }

  const startTime = Date.now();
  await setDoc(sessionRef, {
    started: true,
    startTime,
    pairingReady: false,
    instructorCode: code,
    expectedCount: expected,
    expiresAt: new Date(startTime + DAY_MS),
    updatedAt: serverTimestamp()
  }, { merge: true });

  isInstructor = true;
  localStorage.setItem('pd_is_instructor', 'true');

  instructorBar.classList.add('hidden');
  showOnly('managementScreen');
  await updateManagementScreen();

  barStatus.textContent = "הפעילות הופעלה";
});

generatePairsBtn.addEventListener('click', async () => {
  await setDoc(sessionRef, { pairingReady: true, updatedAt: serverTimestamp() }, { merge: true });
  managementNote.textContent = "מייצר זוגות...";
});

window.next = (n) => {
  if (n === 2) {
    const required = ['mainDomain', 'secondDomain'];
    if (required.some(k => !selections[k])) {
      alert('נא לענות על כל השאלות לפני המשך');
      return;
    }
  }
  if (n === 3) {
    const required = ['workStyle', 'teamStyle', 'workPace'];
    if (required.some(k => !selections[k])) {
      alert('נא לענות על כל השאלות לפני המשך');
      return;
    }
  }
  if (n === 4) {
    const required = ['teamRole', 'motivationSource'];
    if (required.some(k => !selections[k])) {
      alert('נא לענות על כל השאלות לפני המשך');
      return;
    }
  }
  if (n === 5) {
    const required = ['pressureResponse', 'conflictStyle', 'communicationStyle', 'lifeInterest'];
    if (required.some(k => !selections[k])) {
      alert('נא לענות על כל השאלות לפני המשך');
      return;
    }
  }

  showOnly('step' + n);
};

startBtn.addEventListener('click', () => {
  if(sessionEndsAt && Date.now() > sessionEndsAt){
    resetToWaiting();
    return;
  }
  showOnly('step1');
});

window.finish = async () => {
  if (!displayName.value.trim()) {
    alert('כתבי שם פרטי/כינוי כדי שתוכלי לזהות את עצמך במסך החיבורים.');
    return;
  }

  const required = [
    'mainDomain', 'secondDomain', 'workStyle', 'teamStyle', 'workPace',
    'teamRole', 'motivationSource', 'pressureResponse', 'conflictStyle',
    'communicationStyle', 'lifeInterest', 'importanceLevel'
  ];
  
  const missing = required.filter(k => !selections[k]);
  if (missing.length) {
    alert('נא לענות על כל השאלות לפני סיום.');
    return;
  }

  if (sessionEndsAt && Date.now() > sessionEndsAt) {
    resetToWaiting();
    return;
  }

  const payload = {
    sessionId: SESSION_ID,
    deviceId,
    displayName: displayName.value.trim(),
    mainDomain: selections.mainDomain,
    secondDomain: selections.secondDomain,
    workStyle: selections.workStyle,
    teamStyle: selections.teamStyle,
    workPace: selections.workPace,
    teamRole: selections.teamRole,
    motivationSource: selections.motivationSource,
    pressureResponse: selections.pressureResponse,
    conflictStyle: selections.conflictStyle,
    communicationStyle: selections.communicationStyle,
    lifeInterest: selections.lifeInterest,
    importanceLevel: selections.importanceLevel,
    createdAt: Date.now(),
    expiresAt: new Date(Date.now() + DAY_MS)
  };

  await setDoc(doc(responsesRef, crypto.randomUUID()), payload);
  showOnly('waiting');
};

function calculateScore(a, b) {
  let score = 0;
  let reasons = [];

  if (a.mainDomain === b.mainDomain) {
    score += 15;
    reasons.push(`שתיכן בחרתן ב${a.mainDomain} כתחום עיקרי`);
  }
  
  if (a.mainDomain === b.secondDomain && b.secondDomain !== "אני מעדיפה להתמקד בתחום אחד") {
    score += 8;
    reasons.push(`${b.displayName || 'השותפה'} מתעניינת גם ב${a.mainDomain}`);
  }
  if (b.mainDomain === a.secondDomain && a.secondDomain !== "אני מעדיפה להתמקד בתחום אחד") {
    score += 8;
    reasons.push(`${a.displayName || 'את'} מתעניינת גם ב${b.mainDomain}`);
  }
  
  if (a.secondDomain === b.secondDomain && 
      a.secondDomain !== "אני מעדיפה להתמקד בתחום אחד") {
    score += 5;
  }
  
  if (a.secondDomain === "אני מעדיפה להתמקד בתחום אחד" && 
      b.secondDomain === "אני מעדיפה להתמקד בתחום אחד") {
    score += 3;
  }

  if (a.workStyle !== b.workStyle) {
    score += 8;
    reasons.push('סגנונות עבודה משלימים');
  } else {
    score += 2;
  }
  
  if (a.teamStyle !== b.teamStyle) {
    score += 7;
    reasons.push('איזון מצוין בתקשורת');
  } else {
    score += 3;
  }
  
  if (a.workPace === b.workPace && a.workPace !== "תלוי במשימה - אני גמישה") {
    score += 5;
  } else if (a.workPace === "תלוי במשימה - אני גמישה" || 
             b.workPace === "תלוי במשימה - אני גמישה") {
    if (a.workPace === "תלוי במשימה - אני גמישה" && 
        b.workPace === "תלוי במשימה - אני גמישה") {
      score += 8;
      reasons.push('שתיכן גמישות בקצב העבודה');
    } else {
      score += 6;
    }
  }

  if (a.teamRole !== b.teamRole) {
    score += 7;
    
    if ((a.teamRole === "למצוא רעיונות מקוריים ולהתחיל דברים חדשים" && 
         b.teamRole === "לארגן משימות ולוודא שהכל זורם בזמן") ||
        (b.teamRole === "למצוא רעיונות מקוריים ולהתחיל דברים חדשים" && 
         a.teamRole === "לארגן משימות ולוודא שהכל זורם בזמן")) {
      score += 2;
      reasons.push('קומבינציה מושלמת: רעיונות + ארגון');
    }
  } else {
    score += 2;
  }
  
  if (a.motivationSource === b.motivationSource) {
    score += 6;
    reasons.push('אותה מוטיבציה מניעה את שתיכן');
  } else {
    score += 3;
  }

  if ((a.pressureResponse === "אני פועלת הכי טוב תחת לחץ - זה מניע אותי" && 
       b.pressureResponse === "אני צריכה לתכנן מראש כדי למנוע לחץ") ||
      (b.pressureResponse === "אני פועלת הכי טוב תחת לחץ - זה מניע אותי" && 
       a.pressureResponse === "אני צריכה לתכנן מראש כדי למנוע לחץ")) {
    score += 9;
    reasons.push('איזון מושלם בניהול לחץ');
  } else {
    score += 4;
  }
  
  if ((a.conflictStyle === "עוצרת ומנסה להבין לעומק את הצד השני" && 
       b.conflictStyle === "מציגה את העמדה שלי בבירור ומנסה לשכנע") ||
      (b.conflictStyle === "עוצרת ומנסה להבין לעומק את הצד השני" && 
       a.conflictStyle === "מציגה את העמדה שלי בבירור ומנסה לשכנע")) {
    score += 8;
    reasons.push('שילוב מעולה: אחת מקשיבה ואחת מובילה');
  } else if (a.conflictStyle === "מחפשת פשרה שמשלבת את שני הצדדים" || 
             b.conflictStyle === "מחפשת פשרה שמשלבת את שני הצדדים") {
    if (a.conflictStyle === b.conflictStyle) {
      score += 9;
      reasons.push('שתיכן מחפשות פשרות');
    } else {
      score += 7;
    }
  } else {
    score += 5;
  }
  
  if (a.communicationStyle === b.communicationStyle && 
      a.communicationStyle !== "לא משנה לי - אני גמישה") {
    score += 8;
    reasons.push('אותו סגנון תקשורת מועדף');
  } else if (a.communicationStyle === "לא משנה לי - אני גמישה" || 
             b.communicationStyle === "לא משנה לי - אני גמישה") {
    score += 7;
  } else {
    score += 2;
  }

  if (a.lifeInterest === b.lifeInterest) {
    score += 4;
  } else {
    score += 1;
  }

  let multiplier = 1;
  if (a.importanceLevel === "מאוד חשוב - אני רוצה התאמה הכי טובה" ||
      b.importanceLevel === "מאוד חשוב - אני רוצה התאמה הכי טובה") {
    multiplier = 1.3;
  }
  
  score = score * multiplier;

  const nameKey = (a.displayName + '|' + b.displayName)
    .split('')
    .reduce((acc, ch) => acc + ch.charCodeAt(0), 0);
  score += (nameKey % 7) * 0.01;

  return { score: Math.round(score * 100) / 100, reasons };
}

function pickBestPairs(students) {
  let available = [...students];
  let pairs = [];
  
  while (available.length > 1) {
    let bestPair = { i: -1, j: -1, scoreData: { score: -Infinity } };
    
    for (let i = 0; i < available.length; i++) {
      for (let j = i + 1; j < available.length; j++) {
        const scoreData = calculateScore(available[i], available[j]);
        if (scoreData.score > bestPair.scoreData.score) {
          bestPair = { i, j, scoreData };
        }
      }
    }
    
    if (bestPair.i !== -1) {
      pairs.push({
        a: available[bestPair.i],
        b: available[bestPair.j],
        scoreData: bestPair.scoreData
      });
      
      available = available.filter((_, idx) => 
        idx !== bestPair.i && idx !== bestPair.j
      );
    }
  }

  let trio = null;
  if (available.length === 1 && pairs.length > 0) {
    const lone = available[0];
    let bestTrioIdx = 0;
    let bestTrioScore = -Infinity;
    
    for (let k = 0; k < pairs.length; k++) {
      const score1 = calculateScore(lone, pairs[k].a).score;
      const score2 = calculateScore(lone, pairs[k].b).score;
      const totalScore = score1 + score2;
      
      if (totalScore > bestTrioScore) {
        bestTrioScore = totalScore;
        bestTrioIdx = k;
      }
    }
    
    trio = { lone, withPairIndex: bestTrioIdx };
  }

  return { pairs, trio };
}

async function showPairing(){
  if(pairingShown) return;
  pairingShown = true;

  showOnly('thinking');
  await new Promise(r=>setTimeout(r,5000));

  const snap = await getDocs(responsesRef);
  const now = Date.now();
  const all = snap.docs.map(d => d.data());

  const students = all
    .filter(x => x.sessionId === SESSION_ID)
    .filter(x => typeof x.createdAt === 'number' && (now - x.createdAt) <= DAY_MS);

  if(students.length < 2){
    resetToWaiting();
    return;
  }

  const {pairs, trio} = pickBestPairs(students);

  pairingResult.innerHTML = "";

  pairs.forEach((p) => {
    const div = document.createElement('div');
    div.className = 'quote';
    
    const reasonsText = p.scoreData.reasons.length > 0 
      ? `<br><span style="opacity:.75;font-size:13px">${p.scoreData.reasons.slice(0,2).join(' • ')}</span>`
      : '';
    
    div.innerHTML = `
      <strong>${p.a.displayName}</strong> ↔ <strong>${p.b.displayName}</strong><br>
      <span style="opacity:.9">תחום: ${p.a.mainDomain} · ${p.b.mainDomain}</span>${reasonsText}
    `;
    pairingResult.appendChild(div);
  });

  if(trio && pairs[trio.withPairIndex]){
    const tDiv = document.createElement('div');
    tDiv.className = 'quote';
    const base = pairs[trio.withPairIndex];
    tDiv.innerHTML = `
      <strong>שלשה</strong><br>
      ${base.a.displayName} · ${base.b.displayName} · ${trio.lone.displayName}<br>
      <span style="opacity:.85">בכיתה עם מספר אי-זוגי - נוצרת שלשה אחת כדי לשמור על שותפות לכל משתתפת.</span>
    `;
    pairingResult.appendChild(tDiv);
  }

  showOnly('pairing');
}

window.resetApp = async () => {
  if(!confirm('האם את בטוחה? פעולה זו תמחק את כל התשובות ותאפס את המערכת.')){
    return;
  }
  
  const snap = await getDocs(responsesRef);
  const deletePromises = snap.docs.map(doc => deleteDoc(doc.ref));
  await Promise.all(deletePromises);
  
  await deleteDoc(sessionRef);
  
  localStorage.removeItem('pd_is_instructor');
  isInstructor = false;
  
  resetToWaiting();
  openInstructorBtn.classList.remove('hidden');
  
  alert('המערכת אופסה בהצלחה!');
};
</script>
</body>
</html>
