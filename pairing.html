<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>×¤×•×¨×¦×•×ª ×“×¨×š | ×—×™×‘×•×¨ ×œ×©×•×ª×¤×•×ª</title>

<style>
:root{
  --bg:#0f172a;
  --card:rgba(255,255,255,.08);
  --border:rgba(255,255,255,.18);
  --text:#f8fafc;
  --muted:#c7d2fe;
  --accent:#ec4899;
  --accent2:#6366f1;
  --radius:18px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,"Segoe UI",Arial;background:linear-gradient(145deg,#020617,#0f172a);color:var(--text)}

.container{max-width:760px;margin:auto;padding:24px;padding-top:92px}

/* ×¤×¡ ×¢×œ×™×•×Ÿ ×œ××“×¨×™×›×” */
#instructorBar{
  position:fixed;
  top:0;left:0;right:0;
  background:rgba(2,6,23,.92);
  border-bottom:1px solid var(--border);
  z-index:100;
  backdrop-filter: blur(10px);
}
#instructorBar .inner{
  max-width:760px;
  margin:auto;
  padding:10px 24px;
  display:flex;
  gap:10px;
  align-items:center;
}
#instructorBar label{margin:0;font-size:12px;color:var(--muted)}
#instructorBar input{
  padding:8px 10px;
  font-size:14px;
  width:120px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(0,0,0,.25);
  color:var(--text);
  outline:none;
}
#instructorBar button{
  margin:0;
  padding:8px 14px;
  font-size:14px;
  width:auto;
  border:none;
  border-radius:12px;
  font-weight:800;
  cursor:pointer;
  color:white;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
}
#instructorBar .status{
  margin-right:auto;
  font-size:12px;
  color:rgba(248,250,252,.8);
}

.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:26px;margin-bottom:18px}

h1{margin:0 0 12px;font-size:24px;color:var(--accent)}
h2{margin:0 0 10px;font-size:18px}
p{color:var(--muted);line-height:1.75;margin:0 0 12px}

button.primary{width:100%;margin-top:16px;padding:14px;border:none;border-radius:14px;font-weight:800;cursor:pointer;color:white;background:linear-gradient(135deg,var(--accent),var(--accent2))}

/* ×›×¤×ª×•×¨ ×”×ª×—×œ×” ×§×˜×Ÿ â€“ ×œ×¤×™ ××•×¨×š ×”××™×œ×” */
button.start-compact{
  width:auto;
  display:inline-block;
  padding:10px 18px;
  border-radius:999px;
  font-size:16px;
  font-weight:900;
  margin:16px auto 0;
}

/* ×× ×™××¦×™×™×ª ×”×•×¤×¢×” ×¨×›×” ×œ×›×¤×ª×•×¨ ×”×ª×—×œ×” */
@keyframes softAppear{
  from{opacity:0;transform:translateY(8px) scale(.98)}
  to{opacity:1;transform:translateY(0) scale(1)}
}
.start-animate{animation:softAppear .6s ease-out both;}

button.secondary{width:100%;margin-top:12px;padding:14px;border-radius:14px;font-weight:800;cursor:pointer;color:var(--text);background:transparent;border:1px solid var(--border)}

.hidden{display:none}
.quote{margin:16px 0;padding:14px;border-radius:14px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.18);font-weight:650;text-align:center}

.intro-note{margin:14px 0 6px;padding:14px 14px 12px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14)}
.intro-note p{margin:0 0 10px;color:rgba(248,250,252,.92)}
.intro-note ul{margin:0;padding:0 18px 0 0;color:var(--muted);line-height:1.8}
.intro-note li{margin:6px 0}

label{display:block;margin-top:14px;color:#f1f5ff;font-weight:700}
input{width:100%;padding:12px;margin-top:6px;border-radius:12px;border:1px solid var(--border);background:rgba(0,0,0,.35);color:#ffffff;font-size:15px}

/* ×§×‘×•×¦×•×ª ×œ×—×™×¦×” ×‘××§×•× select */
.choice-group{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
.choice{padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:rgba(0,0,0,.25);cursor:pointer;font-weight:600;transition:.2s}
.choice:hover{background:rgba(255,255,255,.08)}
.choice.active{background:linear-gradient(135deg,rgba(236,72,153,.35),rgba(99,102,241,.35));border-color:var(--accent)}
@media (min-width:520px){.choice-group{grid-template-columns:1fr 1fr}}

.small-note{font-size:13px;color:rgba(199,210,254,.9);margin-top:10px}
.warn{color:#fde68a}

/* × × ×œ×”××ª×™×Ÿ â€“ ×•×¨×•×“ ×–×•×”×¨ */
.wait-text{
  text-align:center;
  font-size:20px;
  font-weight:900;
  color:#ff3ea5;
  text-shadow:0 0 8px rgba(255,62,165,.8),0 0 18px rgba(255,62,165,.6);
  margin-top:18px;
}

/* ××¡×š ×—×©×™×‘×” */
.thinking{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px}
@keyframes blink{0%,100%{opacity:.3}50%{opacity:1}}
.thinking-dots span{font-size:32px;color:#ff3ea5;animation:blink 1.2s infinite}
.thinking-dots span:nth-child(2){animation-delay:.2s}
.thinking-dots span:nth-child(3){animation-delay:.4s}
</style>
</head>

<body>
<!-- ×¤×¡ ××“×¨×™×›×” ×¢×œ×™×•×Ÿ (××•×¡×ª×¨ ×›×‘×¨×™×¨×ª ××—×“×œ) -->
<div id="instructorBar" class="hidden">
  <div class="inner">
    <label for="instructorCode">×§×•×“ ××“×¨×™×›×”</label>
    <input id="instructorCode" inputmode="numeric" placeholder="â€¢â€¢â€¢â€¢" autocomplete="one-time-code">
    <label for="expectedCount" style="margin-right:8px">××¡×³ ××©×ª×ª×¤×•×ª</label>
    <input id="expectedCount" inputmode="numeric" placeholder="18" style="width:90px">
    <button id="activateBtn" type="button">×”×ª×—×œ ×¤×¢×™×œ×•×ª</button>
    <div class="status" id="barStatus">×”×¤×¢×™×œ×•×ª ×¢×“×™×™×Ÿ ×œ× ×”×•×¤×¢×œ×”</div>
  </div>
</div>

<div class="container">

  <!-- ×›×¤×ª×•×¨ ×¤×ª×™×—×ª ××–×•×¨ ××“×¨×™×›×” -->
  <button id="openInstructor" class="secondary" type="button" style="margin-bottom:12px">×›× ×™×¡×ª ××“×¨×™×›×”</button>

  <!-- ××¡×š ×¤×ª×™×—×” / ×”××ª× ×” -->
  <div class="card" id="introScreen">
    <h1>×‘×—×™×¨×ª ×©×•×ª×¤×” ×œ×ª×”×œ×™×š</h1>
    <div class="intro-note">
      <p><strong>×”×¤×¢×™×œ×•×ª ×”×–×• ××™× ×” ××‘×—×Ÿ</strong> â€” ×•××™×Ÿ ×‘×” ×ª×©×•×‘×•×ª × ×›×•× ×•×ª ××• ×œ× × ×›×•× ×•×ª.</p>
      <p>×”××˜×¨×” ×”×™× ×œ×™×¦×•×¨ <strong>×©×•×ª×¤×•×ª ×˜×•×‘×”</strong> ×œ×¢×‘×•×“×” ××©×•×ª×¤×ª ×‘×ª×”×œ×™×š ×”×ª×™×›×•×Ÿ ×”×”× ×“×¡×™.</p>
      <ul>
        <li><strong>×”×™×›×¨×•×ª</strong> â€” ×œ×”×‘×™×Ÿ ××™ ××ª ×•××™×š × ×•×— ×œ×š ×œ×¢×‘×•×“</li>
        <li><strong>×××•×Ÿ</strong> â€” ×œ×”×ª×—×™×œ ×™×—×“ ×‘×ª×—×•×©×” ×˜×•×‘×” ×•×‘×˜×•×—×”</li>
        <li><strong>×“×™×•×§</strong> â€” ×œ×‘×—×•×¨ ×©×•×ª×¤×” ×©×ª×¢×–×•×¨ ×œ×›×Ÿ ×œ×”×ª×§×“× ×‘×××ª</li>
      </ul>
    </div>
    <div class="quote">×¤×•×¨×¦×ª ×“×¨×š ××¦×œ×™×—×” ×›×©×”×™× ×¦×•×¢×“×ª ×§×“×™××” ×¢× × ×©×™× ××¦×œ×™×—×•×ª ×›××•×”.</div>

    <p class="wait-text" id="waitText"><strong>× × ×œ×”××ª×™×Ÿ</strong></p>

    <button id="startBtn" class="primary start-compact hidden" type="button">××ª×—×™×œ×•×ª</button>
    <p id="lockedMsg" class="small-note warn hidden">×”×¤×¢×™×œ×•×ª ×”×¡×ª×™×™××” ×•× × ×¢×œ×”. ×× ×¦×¨×™×š â€” ×”××“×¨×™×›×” ×™×›×•×œ×” ×œ×”×¤×¢×™×œ ×©×•×‘.</p>
  </div>

  <!-- ×©×œ×‘ 1 -->
  <div class="card hidden" id="step1">
    <h2>×œ×¤× ×™ ×©××ª×—×™×œ×•×ª</h2>
    <label>×©× ×¤×¨×˜×™ / ×›×™× ×•×™ (×›×“×™ ×©×ª×•×›×œ×™ ×œ×–×”×•×ª ××ª ×¢×¦××š ×‘××¡×š ×”×—×™×‘×•×¨×™×)</label>
    <input id="displayName" placeholder="×œ×“×•×’××”: × ×•×¢×”" maxlength="24">

    <h2 style="margin-top:18px">×ª×—×•××™ ×¢× ×™×™×Ÿ</h2>
    <label>××” ×”×ª×—×•× ×”××¨×›×–×™ ×©×‘×—×¨×ª?</label>
    <div class="choice-group" data-field="mainDomain">
      <div class="choice">×”×™×™×˜×§ ×•×œ×™×‘×”</div>
      <div class="choice">××“× ×•×˜×›× ×•×œ×•×’×™×”</div>
      <div class="choice">×¡×‘×™×‘×” ×•×§×™×™××•×ª</div>
      <div class="choice">×¢×ª×™×“ ×•×™×–××•×ª</div>
      <div class="choice">×—×‘×¨×” ×•×“×™×’×™×˜×œ</div>
    </div>

    <label>×”×× ×™×© ×ª×—×•× × ×•×¡×£ ×©××¢× ×™×™×Ÿ ××•×ª×š?</label>
    <div class="choice-group" data-field="secondDomain">
      <div class="choice">×”×™×™×˜×§ ×•×œ×™×‘×”</div>
      <div class="choice">××“× ×•×˜×›× ×•×œ×•×’×™×”</div>
      <div class="choice">×¡×‘×™×‘×” ×•×§×™×™××•×ª</div>
      <div class="choice">×¢×ª×™×“ ×•×™×–××•×ª</div>
      <div class="choice">×—×‘×¨×” ×•×“×™×’×™×˜×œ</div>
      <div class="choice">××™×Ÿ ×ª×—×•× × ×•×¡×£ ×©××¢× ×™×™×Ÿ ××•×ª×™ ×›×¨×’×¢</div>
    </div>

    <button class="primary" type="button" onclick="next(2)">×”××©×š</button>
  </div>

  <!-- ×©×œ×‘ 2 -->
  <div class="card hidden" id="step2">
    <h2>××™×š ××ª ×¤×•×¢×œ×ª?</h2>
    <label>×›×©×™×© ××©×™××” ×—×“×©×” ×•×œ× ×‘×¨×•×¨×”:</label>
    <div class="choice-group" data-field="workStyle">
      <div class="choice">××ª×—×™×œ×” ×œ×”×ª× ×¡×•×ª ×•×œ×•××“×ª ×ª×•×š ×›×“×™</div>
      <div class="choice">×¢×•×¦×¨×ª ×œ×”×‘×™×Ÿ ×•×œ×ª×›× ×Ÿ</div>
    </div>

    <label>×‘×¢×‘×•×“×” ×‘×–×•×’:</label>
    <div class="choice-group" data-field="teamStyle">
      <div class="choice">×—×•×©×‘×ª ×‘×§×•×œ ×•××©×ª×¤×ª</div>
      <div class="choice">×¢×•×‘×“×ª ×‘×©×§×˜ ×•××– ××¦×™×’×”</div>
    </div>

    <button class="primary" type="button" onclick="next(3)">×”××©×š</button>
    <button class="secondary" type="button" onclick="next(1)">×—×–×¨×”</button>
  </div>

  <!-- ×©×œ×‘ 3 -->
  <div class="card hidden" id="step3">
    <h2>×§×¦×ª ××”×—×™×™× ×©×œ×š</h2>

    <label>××™×–×” ×ª×•×›×Ÿ ××•×©×š ××•×ª×š ×‘×××ª ×‘×™×•×-×™×•×?</label>
    <div class="choice-group" data-field="lifeInterest">
      <div class="choice">×˜×›× ×•×œ×•×’×™×” ×•××¤×œ×™×§×¦×™×•×ª</div>
      <div class="choice">×× ×©×™× ×•×”×©×¤×¢×” ×—×‘×¨×ª×™×ª</div>
      <div class="choice">×¡×‘×™×‘×” ×•×§×™×™××•×ª</div>
      <div class="choice">×¨×¢×™×•× ×•×ª ×•×¢×ª×™×“</div>
    </div>

    <label>××ª×™ ××ª ××¨×’×™×©×” ×©××ª ××‘×™××” ×¢×¨×š ×œ×§×‘×•×¦×”?</label>
    <div class="choice-group" data-field="valuePlace">
      <div class="choice">×›×©×× ×™ ××‘×™××” ×¨×¢×™×•×Ÿ ×—×“×©</div>
      <div class="choice">×›×©×× ×™ ×¢×•×–×¨×ª ×œ×”×‘×™×Ÿ</div>
      <div class="choice">×›×©×× ×™ ××—×‘×¨×ª ×× ×©×™×</div>
      <div class="choice">×›×©×× ×™ ××©× ×” ××¦×‘ ×§×™×™×</div>
    </div>

    <label>×›×©×™×© ××™Ö¾×”×¡×›××” ×‘×¢×‘×•×“×” ××©×•×ª×¤×ª, ××” ××ª × ×•×˜×” ×œ×¢×©×•×ª?</label>
    <div class="choice-group" data-field="conflictStyle">
      <div class="choice">×¢×•×¦×¨×ª ×•×× ×¡×” ×œ×”×‘×™×Ÿ ××ª ×”×¦×“ ×”×©× ×™</div>
      <div class="choice">××¦×™×’×” ×¢××“×” ×‘×¨×•×¨×” ×•×× ×¡×” ×œ×©×›× ×¢</div>
    </div>

    <label>××” ×¢×•×–×¨ ×œ×š ×œ×”×ª××™×“ ×‘×¤×¨×•×™×§×˜ ×œ××•×¨×š ×–××Ÿ?</label>
    <div class="choice-group" data-field="motivationSource">
      <div class="choice">×ª×—×•×©×ª ××©××¢×•×ª ×•×”×©×¤×¢×”</div>
      <div class="choice">××ª×’×¨ ×•×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª</div>
    </div>

    <button class="primary" type="button" onclick="finish()">×¡×™×™××ª×™ â€“ ××•×›× ×” ×œ×©×•×ª×¤×•×ª</button>
    <button class="secondary" type="button" onclick="next(2)">×—×–×¨×”</button>
  </div>

  <!-- ××¡×š ×”××ª× ×” ×œ××—×¨ ××™×œ×•×™ -->
  <div class="card hidden" id="waiting">
    <h1>××—×›×•×ª ×™×—×“</h1>
    <p>××¢×•×œ×” â€” ×”×‘×—×™×¨×•×ª ×©×œ×š × ×©××¨×•.</p>
    <p>×›×©×”××“×¨×™×›×” ×ª×™×™×¦×¨ ××ª ×”×—×™×‘×•×¨×™×, ×ª×¨××™ ×›××Ÿ ××ª ×ª×•×¦××ª ×”×©×•×ª×¤×•×ª.</p>
  </div>

  <!-- ××¡×š ×—×©×™×‘×” ×œ×¤× ×™ ×—×™×‘×•×¨×™× -->
  <div class="card hidden" id="thinking">
    <div class="thinking">
      <h1>×—×•×©×‘×•×ª ×™×—×“</h1>
      <div class="thinking-dots"><span>â€¢</span><span>â€¢</span><span>â€¢</span></div>
      <p class="small-note">××—×¤×©×•×ª ××ª ×”×©×•×ª×¤×•×ª ×”××“×•×™×§×ª ×‘×™×•×ª×¨â€¦</p>
    </div>
  </div>

  <!-- ××¡×š ×—×™×‘×•×¨×™× -->
  <div class="card hidden" id="pairing">
    <h1>××¡×š ×”×—×™×‘×•×¨×™×</h1>
    <p>×©×•×ª×¤×•×ª ×˜×•×‘×” × ×‘× ×™×ª ××©×™×œ×•×‘ ×©×œ <strong>×ª×—×•××™ ×¢× ×™×™×Ÿ ××©×•×ª×¤×™×</strong> ×•×“×¨×š ×¢×‘×•×“×” ××©×œ×™××”.</p>
    <p class="small-note">×–×•×”×™ ××™×•×× ×•×ª ××¨×›×–×™×ª ×‘×¢×•×œ× ×”×”×™×™×˜×§: ×œ×“×¢×ª ×œ×¢×‘×•×“ ×™×—×“, ×œ×—×œ×•×§ ××—×¨×™×•×ª, ×•×œ× ×•×¢ ×§×“×™××” ×›×¦×•×•×ª.</p>
    <div id="pairingResult"></div>
    <button class="secondary" type="button" onclick="goHome()">×—×–×¨×” ×œ×“×£ ×”×‘×™×ª</button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  onSnapshot,
  collection,
  getDocs,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCFSq5b-HgkTxFNhBJIBdOe2ian5TZvMPE",
  authDomain: "portzot-derech.firebaseapp.com",
  projectId: "portzot-derech"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ğŸ”’ ××¡××›×™×/×§×•×œ×§×¦×™×•×ª (××•×ª×× ×œ×¨×•×œ×¡: instructors / sessions / responses)
const SESSION_ID = "active";
const sessionRef = doc(db, "sessions", SESSION_ID);
const responsesRef = collection(db, "responses");

const SESSION_DURATION_MS = 20 * 60 * 1000; // 20 ×“×§×•×ª
const DAY_MS = 24 * 60 * 60 * 1000;

// ×§××© ×§×˜×Ÿ ×‘×“×¤×“×¤×Ÿ ×œ×× ×™×¢×ª ××™×œ×•×™ ×›×¤×•×œ ×××•×ª×• ××›×©×™×¨
const DEVICE_ID_KEY = "pd_pairing_device_id";
const deviceId = localStorage.getItem(DEVICE_ID_KEY) || crypto.randomUUID();
localStorage.setItem(DEVICE_ID_KEY, deviceId);

// DOM
const openInstructorBtn = document.getElementById('openInstructor');
const startBtn = document.getElementById('startBtn');
const lockedMsg = document.getElementById('lockedMsg');
const waitText = document.getElementById('waitText');

const activateBtn = document.getElementById('activateBtn');
const expectedCountInput = document.getElementById('expectedCount');
const instructorCode = document.getElementById('instructorCode');
const barStatus = document.getElementById('barStatus');

const displayName = document.getElementById('displayName');
const pairingResult = document.getElementById('pairingResult');

// ×¢×¨×›×™× × ×‘×—×¨×™× ××§×‘×•×¦×•×ª ×œ×—×™×¦×”
const selections = {};
document.querySelectorAll('.choice-group').forEach(group=>{
  const field = group.dataset.field;
  group.querySelectorAll('.choice').forEach(ch=>{
    ch.addEventListener('click',()=>{
      group.querySelectorAll('.choice').forEach(c=>c.classList.remove('active'));
      ch.classList.add('active');
      selections[field] = ch.textContent.trim();
    });
  });
});

function showOnly(id){
  document.querySelectorAll('.container .card').forEach(c => c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

function setStartEnabled(enabled){
  if(enabled){
    startBtn.classList.remove('hidden');
    startBtn.classList.remove('start-animate');
    requestAnimationFrame(() => startBtn.classList.add('start-animate'));
    lockedMsg.classList.add('hidden');
  } else {
    startBtn.classList.add('hidden');
  }
}

function setLockedMessage(on){
  if(on) lockedMsg.classList.remove('hidden');
  else lockedMsg.classList.add('hidden');
}

function hideWaitUI(){
  waitText?.classList.add('hidden');
}

// ××¦×‘ ×‘×¨×™×¨×ª ××—×“×œ
openInstructorBtn.addEventListener('click', () => {
  document.getElementById('instructorBar').classList.toggle('hidden');
});
showOnly('introScreen');
setStartEnabled(false);
setLockedMessage(false);

// ××¦×‘ ×¡×©×Ÿ
let currentSession = null;
let sessionEndsAt = 0;
let sessionStartedAt = 0;

async function countValidResponses(){
  const snap = await getDocs(responsesRef);
  const now = Date.now();
  let c = 0;
  snap.docs.forEach(d => {
    const x = d.data();
    if(x.sessionId === SESSION_ID && typeof x.createdAt === 'number' && (now - x.createdAt) <= DAY_MS){
      c++;
    }
  });
  return c;
}

async function isSessionActive(data){
  if(!data?.started || typeof data.startTime !== 'number') return false;
  const endAt = data.startTime + SESSION_DURATION_MS;
  return Date.now() < endAt;
}

// ×××–×™×Ÿ ×œ×¡×©×Ÿ
onSnapshot(sessionRef, async (snap) => {
  if(!snap.exists()){
    barStatus.textContent = "×”×¤×¢×™×œ×•×ª ×¢×“×™×™×Ÿ ×œ× ×”×•×¤×¢×œ×”";
    setStartEnabled(false);
    setLockedMessage(false);
    return;
  }

  const data = snap.data();
  currentSession = data;

  // ×–××Ÿ ×¡×©×Ÿ
  if(data.started && typeof data.startTime === 'number'){
    sessionStartedAt = data.startTime;
    sessionEndsAt = data.startTime + SESSION_DURATION_MS;

    const now = Date.now();
    if(now < sessionEndsAt){
      const answersCount = await countValidResponses();
      const minsLeft = Math.max(0, Math.ceil((sessionEndsAt - now)/60000));
      const expected = data.expectedCount || 0;
      const progress = expected ? ` Â· ${answersCount}/${expected} ×ª×©×•×‘×•×ª` : '';
      barStatus.textContent = `×¤×¢×™×œ ×¢×›×©×™×• Â· × ×©××¨×• ×‘×¢×¨×š ${minsLeft} ×“×§×³${progress}`;
      setStartEnabled(true);
      hideWaitUI();
    } else {
      barStatus.textContent = "×”×¤×¢×™×œ×•×ª ×”×¡×ª×™×™××”";
      setStartEnabled(false);
      setLockedMessage(true);
      showOnly('introScreen');
    }

    if(data.pairingReady){
      await showPairing();
    }
  } else {
    barStatus.textContent = "×”×¤×¢×™×œ×•×ª ×¢×“×™×™×Ÿ ×œ× ×”×•×¤×¢×œ×”";
    setStartEnabled(false);
  }
});

// ---- ×›×¤×ª×•×¨ ×”××“×¨×™×›×” (×¤×¨×•×“×§×©×Ÿ) ----
// ×œ×—×™×¦×” ×¨××©×•× ×”: ×”×¤×¢×œ×”
// ×œ×—×™×¦×” ×©× ×™×™×” (××—×¨×™ ×©×›×•×œ×Ÿ ×¡×™×™××•): ×™×¦×™×¨×ª ×—×™×‘×•×¨×™×
activateBtn.addEventListener('click', async () => {
  // ×× ××™×Ÿ ×¡×©×Ÿ ×¤×¢×™×œ ×¢×“×™×™×Ÿ â€” × × ×¡×” ×œ×”×¤×¢×™×œ
  const sessionSnap = await getDoc(sessionRef);
  const sessionData = sessionSnap.exists() ? sessionSnap.data() : null;

  const active = await isSessionActive(sessionData);

  if(!active){
    const code = (instructorCode.value || '').trim();
    if(!code){
      barStatus.textContent = "× × ×œ×”×–×™×Ÿ ×§×•×“ ××“×¨×™×›×”";
      return;
    }

    // ×‘×“×™×§×” ×©×§×•×“ ×§×™×™× ×‘Ö¾instructors
    const instructorRef = doc(db, 'instructors', code);
    const instSnap = await getDoc(instructorRef);
    if(!instSnap.exists() || instSnap.data()?.active !== true){
      barStatus.textContent = "×§×•×“ ×œ× ×ª×§×™×Ÿ";
      return;
    }

    // ×”×¤×¢×œ×ª ×¡×©×Ÿ (20 ×“×§×•×ª)
    const startTime = Date.now();
    await setDoc(sessionRef, {
      started: true,
      startTime,
      pairingReady: false,
      instructorCode: code,
      expectedCount: Number(expectedCountInput.value || 0),
      expiresAt: new Date(startTime + DAY_MS),
      updatedAt: serverTimestamp()
    }, { merge: true });

    // ×œ××—×¨ ×”×¤×¢×œ×”: ××¡×ª×™×¨×™× ×§×•×“ ×•×”××ª× ×”
    instructorCode.classList.add('hidden');
    openInstructorBtn.classList.add('hidden');
    hideWaitUI();

    barStatus.textContent = "×”×¤×¢×™×œ×•×ª ×”×•×¤×¢×œ×”";
    setStartEnabled(true);
    return;
  }

  // ×× ×™×© ×¡×©×Ÿ ×¤×¢×™×œ â€” ×–×• ×œ×—×™×¦×” ×©× ×™×™×”: × × ×¡×” ×œ×™×¦×•×¨ ×—×™×‘×•×¨×™×
  const data = sessionData;
  const expected = data?.expectedCount || 0;
  const answersCount = await countValidResponses();

  if(expected && answersCount !== expected){
    barStatus.textContent = `×××ª×™× ×”: ${answersCount}/${expected} ×ª×©×•×‘×•×ª`;
    return;
  }

  await setDoc(sessionRef, { pairingReady: true, updatedAt: serverTimestamp() }, { merge:true });
  barStatus.textContent = "×”×—×™×‘×•×¨×™× × ×•×¦×¨×•";
});

// ---- × ×™×•×•×˜ ×‘×™×Ÿ ×©×œ×‘×™× ----
window.next = (n) => {
  if(n === 1) return showOnly('step1');
  if(n === 2) return showOnly('step2');
  if(n === 3) return showOnly('step3');
};

startBtn.addEventListener('click', () => {
  if(sessionEndsAt && Date.now() > sessionEndsAt){
    setStartEnabled(false);
    setLockedMessage(true);
    return;
  }
  showOnly('step1');
});

// ---- ×©××™×¨×ª ×ª×©×•×‘×•×ª ----
window.finish = async () => {
  if(!displayName.value.trim()){
    alert('×›×ª×‘×™ ×©× ×¤×¨×˜×™/×›×™× ×•×™ ×›×“×™ ×©×ª×•×›×œ×™ ×œ×–×”×•×ª ××ª ×¢×¦××š ×‘××¡×š ×”×—×™×‘×•×¨×™×.');
    return;
  }

  const required = [
    'mainDomain','secondDomain','workStyle','teamStyle',
    'lifeInterest','valuePlace','conflictStyle','motivationSource'
  ];
  const missing = required.filter(k => !selections[k]);
  if(missing.length){
    alert('×¨×§ ×¢×•×“ ×¨×’×¢ â€” ×”×©×œ×™××™ ××ª ×›×œ ×”×‘×—×™×¨×•×ª ×œ×¤× ×™ ×¡×™×•×.');
    return;
  }

  if(sessionEndsAt && Date.now() > sessionEndsAt){
    showOnly('introScreen');
    setLockedMessage(true);
    return;
  }

  const payload = {
    sessionId: SESSION_ID,
    deviceId,
    displayName: displayName.value.trim(),
    mainDomain: selections.mainDomain,
    secondDomain: selections.secondDomain,
    workStyle: selections.workStyle,
    teamStyle: selections.teamStyle,
    lifeInterest: selections.lifeInterest,
    valuePlace: selections.valuePlace,
    conflictStyle: selections.conflictStyle,
    motivationSource: selections.motivationSource,
    instructorCode: currentSession?.instructorCode || null,
    createdAt: Date.now(),
    expiresAt: new Date(Date.now() + DAY_MS)
  };

  await setDoc(doc(responsesRef, crypto.randomUUID()), payload);
  showOnly('waiting');
};

// ---- ××œ×’×•×¨×™×ª× ×—×™×‘×•×¨×™× ----
function score(a, b){
  let s = 0;

  // 1) ×ª×—×•××™ ×¢× ×™×™×Ÿ ××©×•×ª×¤×™× (×—×–×§)
  if(a.mainDomain === b.mainDomain) s += 10;
  if(a.mainDomain === b.secondDomain) s += 6;
  if(b.mainDomain === a.secondDomain) s += 6;

  // 2) ×”×©×œ××” ×‘×¡×’× ×•×Ÿ ×¢×‘×•×“×” (×—×–×§)
  if(a.workStyle !== b.workStyle) s += 5;
  if(a.teamStyle !== b.teamStyle) s += 4;

  // 3) ×—×™×™×/×›×™×•×•×Ÿ (×‘×™× ×•× ×™)
  if(a.lifeInterest === b.lifeInterest) s += 2;
  if(a.valuePlace === b.valuePlace) s += 2;

  // 4) ×”×ª× ×”×œ×•×ª ×‘×§×•× ×¤×œ×™×§×˜ ×•××•×˜×™×‘×¦×™×” (××©×œ×™×)
  if(a.conflictStyle !== b.conflictStyle) s += 3;
  if(a.motivationSource === b.motivationSource) s += 2;

  // ×©×•×‘×¨ ×©×•×•×™×•×Ÿ ×“×˜×¨××™× ×™×¡×˜×™ ×§×˜×Ÿ
  const key = (a.displayName + '|' + b.displayName).split('').reduce((acc,ch)=>acc+ch.charCodeAt(0),0);
  s += (key % 7) * 0.01;

  return s;
}

function pickBestPairs(list){
  let students = [...list];
  let pairs = [];

  while(students.length > 1){
    let best = {i:-1,j:-1,sc:-Infinity};
    for(let i=0;i<students.length;i++){
      for(let j=i+1;j<students.length;j++){
        const sc = score(students[i], students[j]);
        if(sc > best.sc){
          best = {i,j,sc};
        }
      }
    }

    const a = students[best.i];
    const b = students[best.j];
    pairs.push({a,b,sc:best.sc});
    students = students.filter((_,idx)=>idx !== best.i && idx !== best.j);
  }

  let trio = null;
  if(students.length === 1 && pairs.length){
    const lone = students[0];
    let bestIdx = 0;
    let bestTrioScore = -Infinity;
    for(let k=0;k<pairs.length;k++){
      const t = score(lone, pairs[k].a) + score(lone, pairs[k].b);
      if(t > bestTrioScore){
        bestTrioScore = t;
        bestIdx = k;
      }
    }
    trio = { lone, withPairIndex: bestIdx };
  }

  return {pairs, trio};
}

async function showPairing(){
  showOnly('thinking');
  await new Promise(r=>setTimeout(r,5000));

  const snap = await getDocs(responsesRef);
  const now = Date.now();
  const all = snap.docs.map(d => d.data());

  const students = all
    .filter(x => x.sessionId === SESSION_ID)
    .filter(x => typeof x.createdAt === 'number' && (now - x.createdAt) <= DAY_MS);

  if(students.length < 2){
    return;
  }

  const {pairs, trio} = pickBestPairs(students);

  pairingResult.innerHTML = "";

  pairs.forEach((p) => {
    const div = document.createElement('div');
    div.className = 'quote';
    div.innerHTML = `
      <strong>${p.a.displayName}</strong> â†” <strong>${p.b.displayName}</strong><br>
      <span style="opacity:.9">×ª×—×•×: ${p.a.mainDomain} Â· ${p.b.mainDomain}</span><br>
      <span style="opacity:.85">× ×‘×—×¨ ×œ×¤×™ ×ª×—×•××™ ×¢× ×™×™×Ÿ ××©×•×ª×¤×™× ×•×”×©×œ××” ×‘×¡×’× ×•×Ÿ ×¢×‘×•×“×”</span>
    `;
    pairingResult.appendChild(div);
  });

  if(trio && pairs[trio.withPairIndex]){
    const tDiv = document.createElement('div');
    tDiv.className = 'quote';
    const base = pairs[trio.withPairIndex];
    tDiv.innerHTML = `
      <strong>×©×œ×©×”</strong><br>
      ${base.a.displayName} Â· ${base.b.displayName} Â· ${trio.lone.displayName}<br>
      <span style="opacity:.85">×‘×›×™×ª×” ×¢× ××¡×¤×¨ ××™-×–×•×’×™ â€” × ×•×¦×¨×ª ×©×œ×©×” ××—×ª ×›×“×™ ×œ×©××•×¨ ×¢×œ ×©×•×ª×¤×•×ª ×œ×›×œ ××©×ª×ª×¤×ª.</span>
    `;
    pairingResult.appendChild(tDiv);
  }

  showOnly('pairing');
}

// ---- ×‘×“×™×§×•×ª ×¢×¦×××™×•×ª (×¨×§ ×× ××•×¡×™×¤×™× ?test=1 ×œ×›×ª×•×‘×ª) ----
function assert(name, cond){
  if(!cond){
    console.error('TEST FAIL:', name);
  } else {
    console.log('TEST OK:', name);
  }
}

if(new URLSearchParams(location.search).get('test') === '1'){
  // 1) setStartEnabled ×œ× ×–×•×¨×§ ×©×’×™××”
  try{ setStartEnabled(false); setStartEnabled(true); assert('setStartEnabled runs', true); }
  catch(e){ assert('setStartEnabled runs', false); }

  // 2) score ×¡×™××˜×¨×™
  const A = {displayName:'×', mainDomain:'×”×™×™×˜×§ ×•×œ×™×‘×”', secondDomain:'×¢×ª×™×“ ×•×™×–××•×ª', workStyle:'x', teamStyle:'y', lifeInterest:'t', valuePlace:'v', conflictStyle:'c', motivationSource:'m'};
  const B = {displayName:'×‘', mainDomain:'×”×™×™×˜×§ ×•×œ×™×‘×”', secondDomain:'××“× ×•×˜×›× ×•×œ×•×’×™×”', workStyle:'z', teamStyle:'w', lifeInterest:'t', valuePlace:'q', conflictStyle:'d', motivationSource:'m'};
  assert('score is symmetric-ish', Math.abs(score(A,B) - score(B,A)) < 0.2);

  // 3) pickBestPairs ××—×–×™×¨ ×–×•×’×•×ª × ×›×•× ×™×
  const res = pickBestPairs([A,B]);
  assert('pickBestPairs creates one pair', res.pairs.length === 1);
}

// × ×™×•×•×˜ ×“×£ ×‘×™×ª (×”×ª××™××™ ××ª ×”×›×ª×•×‘×ª ××¦×œ×š)
window.goHome = () => {
  window.location.href = "../index.html";
};
</script>
</body>
</html>
