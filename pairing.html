<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>×¤×•×¨×¦×•×ª ×“×¨×š | ×—×™×‘×•×¨ ×œ×©×•×ª×¤×•×ª</title>

<style>
:root{
  --bg:#0f172a;
  --card:rgba(255,255,255,.08);
  --border:rgba(255,255,255,.18);
  --text:#f8fafc;
  --muted:#c7d2fe;
  --accent:#ec4899;
  --accent2:#6366f1;
  --radius:18px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,"Segoe UI",Arial;background:linear-gradient(145deg,#020617,#0f172a);color:var(--text)}

.container{max-width:760px;margin:auto;padding:24px;padding-top:92px}

/* ×¤×¡ ×¢×œ×™×•×Ÿ ×œ××“×¨×™×›×” */
#instructorBar{
  position:fixed;
  top:0;left:0;right:0;
  background:rgba(2,6,23,.92);
  border-bottom:1px solid var(--border);
  z-index:100;
  backdrop-filter: blur(10px);
}
#instructorBar .inner{
  max-width:760px;
  margin:auto;
  padding:10px 24px;
  display:flex;
  gap:10px;
  align-items:center;
}
#instructorBar label{margin:0;font-size:12px;color:var(--muted)}
#instructorBar input{
  padding:8px 10px;
  font-size:14px;
  width:120px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(0,0,0,.25);
  color:var(--text);
  outline:none;
}
#instructorBar button{
  margin:0;
  padding:8px 14px;
  font-size:14px;
  width:auto;
  border:none;
  border-radius:12px;
  font-weight:800;
  cursor:pointer;
  color:white;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
}
#instructorBar .status{
  margin-right:auto;
  font-size:12px;
  color:rgba(248,250,252,.8);
}

.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:26px;margin-bottom:18px}

h1{margin:0 0 12px;font-size:24px;color:var(--accent)}
h2{margin:0 0 10px;font-size:18px}
p{color:var(--muted);line-height:1.75;margin:0 0 12px}

button.primary{width:100%;margin-top:16px;padding:14px;border:none;border-radius:14px;font-weight:800;cursor:pointer;color:white;background:linear-gradient(135deg,var(--accent),var(--accent2))}
button.secondary{width:100%;margin-top:12px;padding:14px;border-radius:14px;font-weight:800;cursor:pointer;color:var(--text);background:transparent;border:1px solid var(--border)}

.hidden{display:none}
.quote{margin:16px 0;padding:14px;border-radius:14px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.18);font-weight:650;text-align:center}

label{display:block;margin-top:14px;color:var(--muted);font-weight:650}
input,select{width:100%;padding:12px;margin-top:6px;border-radius:12px;border:1px solid var(--border);background:rgba(0,0,0,.25);color:var(--text)}

.small-note{font-size:13px;color:rgba(199,210,254,.9);margin-top:10px}
.warn{color:#fde68a}
</style>
</head>

<body>
<!-- ×¤×¡ ××“×¨×™×›×” ×¢×œ×™×•×Ÿ -->
<div id="instructorBar">
  <div class="inner">
    <label for="instructorCode">×§×•×“ ××“×¨×™×›×”</label>
    <input id="instructorCode" inputmode="numeric" placeholder="2311" autocomplete="one-time-code">
    <button id="activateBtn" type="button">×”×ª×—×œ ×¤×¢×™×œ×•×ª</button>
    <div class="status" id="barStatus">×”×¤×¢×™×œ×•×ª ×¢×“×™×™×Ÿ ×œ× ×”×•×¤×¢×œ×”</div>
  </div>
</div>

<div class="container">

  <!-- ××¡×š ×¤×ª×™×—×” / ×”××ª× ×” -->
  <div class="card" id="introScreen">
    <h1>×‘×—×™×¨×ª ×©×•×ª×¤×” ×œ×ª×”×œ×™×š</h1>
    <p>×”×¤×¢×™×œ×•×ª ×”×–×• ××™× ×” ××‘×—×Ÿ ×•××™×Ÿ ×‘×” ×ª×©×•×‘×•×ª × ×›×•× ×•×ª ××• ×œ× × ×›×•× ×•×ª.</p>
    <p>×”××˜×¨×” ×”×™× ×œ×™×¦×•×¨ ×©×•×ª×¤×•×ª ×˜×•×‘×” ×œ×¢×‘×•×“×” ××©×•×ª×¤×ª ×‘×ª×”×œ×™×š ×”×ª×™×›×•×Ÿ ×”×”× ×“×¡×™ â€” ×“×¨×š ×”×™×›×¨×•×ª, ×××•×Ÿ ×•×“×™×•×§.</p>
    <div class="quote">×¤×•×¨×¦×ª ×“×¨×š ××¦×œ×™×—×” ×›×©×”×™× ×¦×•×¢×“×ª ×§×“×™××” ×¢× × ×©×™× ××¦×œ×™×—×•×ª ×›××•×”.</div>
    <p><strong>×›×¨×’×¢ ××—×›×•×ª ×œ×”×¤×¢×œ×” ×©×œ ×”××“×¨×™×›×”.</strong></p>
    <p class="small-note">×‘×¨×’×¢ ×©×”××“×¨×™×›×” ×ª×œ×—×¥ "×”×ª×—×œ ×¤×¢×™×œ×•×ª" ×™×•×¤×™×¢ ×›××Ÿ ×›×¤×ª×•×¨ ×œ×”×ª×—×œ×” â€” ×œ×›×œ ×”×›×™×ª×”.</p>

    <button id="startBtn" class="primary hidden" type="button">××ª×—×™×œ×•×ª</button>
    <p id="lockedMsg" class="small-note warn hidden">×”×¤×¢×™×œ×•×ª ×”×¡×ª×™×™××” ×•× × ×¢×œ×”. ×× ×¦×¨×™×š â€” ×”××“×¨×™×›×” ×™×›×•×œ×” ×œ×”×¤×¢×™×œ ×©×•×‘.</p>
  </div>

  <!-- ×©×œ×‘ 1 -->
  <div class="card hidden" id="step1">
    <h2>×œ×¤× ×™ ×©××ª×—×™×œ×•×ª</h2>
    <label>×©× ×¤×¨×˜×™ / ×›×™× ×•×™ (×›×“×™ ×©×ª×•×›×œ×™ ×œ×–×”×•×ª ××ª ×¢×¦××š ×‘××¡×š ×”×—×™×‘×•×¨×™×)</label>
    <input id="displayName" placeholder="×œ×“×•×’××”: × ×•×¢×”" maxlength="24">

    <h2 style="margin-top:18px">×ª×—×•××™ ×¢× ×™×™×Ÿ</h2>
    <label>××” ×”×ª×—×•× ×”××¨×›×–×™ ×©×‘×—×¨×ª?</label>
    <select id="mainDomain">
      <option value="">×‘×—×¨×™</option>
      <option>×”×™×™×˜×§ ×•×œ×™×‘×”</option>
      <option>××“× ×•×˜×›× ×•×œ×•×’×™×”</option>
      <option>×¡×‘×™×‘×” ×•×§×™×™××•×ª</option>
      <option>×¢×ª×™×“ ×•×™×–××•×ª</option>
      <option>×—×‘×¨×” ×•×“×™×’×™×˜×œ</option>
    </select>

    <label>×”×× ×™×© ×ª×—×•× × ×•×¡×£ ×©××¢× ×™×™×Ÿ ××•×ª×š?</label>
    <select id="secondDomain">
      <option value="">×‘×—×¨×™</option>
      <option>×”×™×™×˜×§ ×•×œ×™×‘×”</option>
      <option>××“× ×•×˜×›× ×•×œ×•×’×™×”</option>
      <option>×¡×‘×™×‘×” ×•×§×™×™××•×ª</option>
      <option>×¢×ª×™×“ ×•×™×–××•×ª</option>
      <option>×—×‘×¨×” ×•×“×™×’×™×˜×œ</option>
      <option>××™×Ÿ ×ª×—×•× × ×•×¡×£ ×©××¢× ×™×™×Ÿ ××•×ª×™ ×›×¨×’×¢</option>
    </select>

    <button class="primary" type="button" onclick="next(2)">×”××©×š</button>
  </div>

  <!-- ×©×œ×‘ 2 -->
  <div class="card hidden" id="step2">
    <h2>××™×š ××ª ×¤×•×¢×œ×ª?</h2>
    <label>×›×©×™×© ××©×™××” ×—×“×©×” ×•×œ× ×‘×¨×•×¨×”:</label>
    <select id="workStyle">
      <option value="">×‘×—×¨×™</option>
      <option>××ª×—×™×œ×” ×œ×”×ª× ×¡×•×ª ×•×œ×•××“×ª ×ª×•×š ×›×“×™</option>
      <option>×¢×•×¦×¨×ª ×œ×”×‘×™×Ÿ ×•×œ×ª×›× ×Ÿ</option>
    </select>

    <label>×‘×¢×‘×•×“×” ×‘×–×•×’:</label>
    <select id="teamStyle">
      <option value="">×‘×—×¨×™</option>
      <option>×—×•×©×‘×ª ×‘×§×•×œ ×•××©×ª×¤×ª</option>
      <option>×¢×•×‘×“×ª ×‘×©×§×˜ ×•××– ××¦×™×’×”</option>
    </select>

    <button class="primary" type="button" onclick="next(3)">×”××©×š</button>
    <button class="secondary" type="button" onclick="next(1)">×—×–×¨×”</button>
  </div>

  <!-- ×©×œ×‘ 3 -->
  <div class="card hidden" id="step3">
    <h2>×§×¦×ª ××”×—×™×™× ×©×œ×š</h2>

    <label>××™×–×” ×ª×•×›×Ÿ ××•×©×š ××•×ª×š ×‘×××ª ×‘×™×•×-×™×•×?</label>
    <select id="lifeInterest">
      <option value="">×‘×—×¨×™</option>
      <option>×˜×›× ×•×œ×•×’×™×” ×•××¤×œ×™×§×¦×™×•×ª</option>
      <option>×× ×©×™× ×•×”×©×¤×¢×” ×—×‘×¨×ª×™×ª</option>
      <option>×¡×‘×™×‘×” ×•×§×™×™××•×ª</option>
      <option>×¨×¢×™×•× ×•×ª ×•×¢×ª×™×“</option>
    </select>

    <label>××ª×™ ××ª ××¨×’×™×©×” ×©××ª ××‘×™××” ×¢×¨×š ×œ×§×‘×•×¦×”?</label>
    <select id="valuePlace">
      <option value="">×‘×—×¨×™</option>
      <option>×›×©×× ×™ ××‘×™××” ×¨×¢×™×•×Ÿ ×—×“×©</option>
      <option>×›×©×× ×™ ×¢×•×–×¨×ª ×œ×”×‘×™×Ÿ</option>
      <option>×›×©×× ×™ ××—×‘×¨×ª ×× ×©×™×</option>
      <option>×›×©×× ×™ ××©× ×” ××¦×‘ ×§×™×™×</option>
    </select>

    <button class="primary" type="button" onclick="finish()">×¡×™×™××ª×™ â€“ ××•×›× ×” ×œ×©×•×ª×¤×•×ª</button>
    <button class="secondary" type="button" onclick="next(2)">×—×–×¨×”</button>
  </div>

  <!-- ××¡×š ×”××ª× ×” ×œ××—×¨ ××™×œ×•×™ -->
  <div class="card hidden" id="waiting">
    <h1>××—×›×•×ª ×™×—×“</h1>
    <p>××¢×•×œ×” â€” ×”×‘×—×™×¨×•×ª ×©×œ×š × ×©××¨×•.</p>
    <p>×›×©×”××“×¨×™×›×” ×ª×™×™×¦×¨ ××ª ×”×—×™×‘×•×¨×™×, ×ª×¨××™ ×›××Ÿ ××ª ×ª×•×¦××ª ×”×©×•×ª×¤×•×ª.</p>
  </div>

  <!-- ××¡×š ×—×™×‘×•×¨×™× -->
  <div class="card hidden" id="pairing">
    <h1>××¡×š ×”×—×™×‘×•×¨×™×</h1>
    <p>×©×•×ª×¤×•×ª ×˜×•×‘×” × ×‘× ×™×ª ××©×™×œ×•×‘ ×©×œ <strong>×ª×—×•××™ ×¢× ×™×™×Ÿ ××©×•×ª×¤×™×</strong> ×•×“×¨×š ×¢×‘×•×“×” ××©×œ×™××”.</p>
    <p class="small-note">×–×•×”×™ ××™×•×× ×•×ª ××¨×›×–×™×ª ×‘×¢×•×œ× ×”×”×™×™×˜×§: ×œ×“×¢×ª ×œ×¢×‘×•×“ ×™×—×“, ×œ×—×œ×•×§ ××—×¨×™×•×ª, ×•×œ× ×•×¢ ×§×“×™××” ×›×¦×•×•×ª.</p>
    <div id="pairingResult"></div>
    <button class="secondary" type="button" onclick="goHome()">×—×–×¨×” ×œ×“×£ ×”×‘×™×ª</button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  onSnapshot,
  collection,
  getDocs,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCFSq5b-HgkTxFNhBJIBdOe2ian5TZvMPE",
  authDomain: "portzot-derech.firebaseapp.com",
  projectId: "portzot-derech"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ğŸ”’ ××¡××›×™×/×§×•×œ×§×¦×™×•×ª (××•×ª×× ×œ×¨×•×œ×¡ ×©×”×’×“×¨×ª: instructors / sessions / responses)
const SESSION_ID = "active";
const sessionRef = doc(db, "sessions", SESSION_ID);
const responsesRef = collection(db, "responses");

const SESSION_DURATION_MS = 20 * 60 * 1000; // 20 ×“×§×•×ª
const DAY_MS = 24 * 60 * 60 * 1000;

// ×§××© ×§×˜×Ÿ ×‘×“×¤×“×¤×Ÿ ×œ×× ×™×¢×ª ××™×œ×•×™ ×›×¤×•×œ ×××•×ª×• ××›×©×™×¨
const DEVICE_ID_KEY = "pd_pairing_device_id";
const deviceId = localStorage.getItem(DEVICE_ID_KEY) || crypto.randomUUID();
localStorage.setItem(DEVICE_ID_KEY, deviceId);

// DOM
const introScreen = document.getElementById('introScreen');
const startBtn = document.getElementById('startBtn');
const lockedMsg = document.getElementById('lockedMsg');
const activateBtn = document.getElementById('activateBtn');
const instructorCode = document.getElementById('instructorCode');
const barStatus = document.getElementById('barStatus');

const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const step3 = document.getElementById('step3');
const waiting = document.getElementById('waiting');
const pairing = document.getElementById('pairing');

const displayName = document.getElementById('displayName');
const mainDomain = document.getElementById('mainDomain');
const secondDomain = document.getElementById('secondDomain');
const workStyle = document.getElementById('workStyle');
const teamStyle = document.getElementById('teamStyle');
const lifeInterest = document.getElementById('lifeInterest');
const valuePlace = document.getElementById('valuePlace');
const pairingResult = document.getElementById('pairingResult');

function showOnly(id){
  document.querySelectorAll('.container .card').forEach(c => c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

function setStartEnabled(enabled){
  if(enabled){
    startBtn.classList.remove('hidden');
    lockedMsg.classList.add('hidden');
  }else{
    startBtn.classList.add('hidden');
  }
}

function setLockedMessage(on){
  if(on) lockedMsg.classList.remove('hidden');
  else lockedMsg.classList.add('hidden');
}

// ××¦×‘ ×‘×¨×™×¨×ª ××—×“×œ: ××¡×š ×¤×ª×™×—×”
showOnly('introScreen');
setStartEnabled(false);
setLockedMessage(false);

// ×××–×™× ×™× ×œ×¡×©×Ÿ
let currentSession = null;
let sessionEndsAt = 0;
let sessionStartedAt = 0;

onSnapshot(sessionRef, async (snap) => {
  if(!snap.exists()){
    barStatus.textContent = "×”×¤×¢×™×œ×•×ª ×¢×“×™×™×Ÿ ×œ× ×”×•×¤×¢×œ×”";
    setStartEnabled(false);
    return;
  }

  const data = snap.data();
  currentSession = data;

  // ×¡×©×Ÿ ×¤×¢×™×œ?
  if(data.started && typeof data.startTime === 'number'){
    sessionStartedAt = data.startTime;
    sessionEndsAt = data.startTime + SESSION_DURATION_MS;

    const now = Date.now();
    if(now < sessionEndsAt){
      const minsLeft = Math.max(0, Math.ceil((sessionEndsAt - now)/60000));
      barStatus.textContent = `×¤×¢×™×œ ×¢×›×©×™×• Â· × ×©××¨×• ×‘×¢×¨×š ${minsLeft} ×“×§×³`;
      setStartEnabled(true);
    }else{
      barStatus.textContent = "×”×¤×¢×™×œ×•×ª ×”×¡×ª×™×™××”";
      setStartEnabled(false);
      setLockedMessage(true);
      // ×× ×ª×œ××™×“×” ×‘×××¦×¢ â€” × ×—×–×™×¨ ×œ×¤×ª×™×—×”
      showOnly('introScreen');
    }

    // ×”×× ×”×—×™×‘×•×¨×™× ×›×‘×¨ ××•×›× ×™×?
    if(data.pairingReady){
      await showPairing();
    }
  }else{
    barStatus.textContent = "×”×¤×¢×™×œ×•×ª ×¢×“×™×™×Ÿ ×œ× ×”×•×¤×¢×œ×”";
    setStartEnabled(false);
  }
});

// ---- ×”×¤×¢×œ×ª ××“×¨×™×›×” ----
activateBtn.addEventListener('click', async () => {
  const code = (instructorCode.value || '').trim();
  if(!code){
    barStatus.textContent = "× × ×œ×”×–×™×Ÿ ×§×•×“ ××“×¨×™×›×”";
    return;
  }

  // ×‘×“×™×§×” ×©×§×•×“ ×§×™×™× ×‘Ö¾instructors
  const instructorRef = doc(db, 'instructors', code);
  const instSnap = await getDoc(instructorRef);
  if(!instSnap.exists() || instSnap.data()?.active !== true){
    barStatus.textContent = "×§×•×“ ×œ× ×ª×§×™×Ÿ";
    return;
  }

  // ×”×¤×¢×œ×ª ×¡×©×Ÿ (20 ×“×§×•×ª)
  const startTime = Date.now();
  await setDoc(sessionRef, {
    started: true,
    startTime,
    pairingReady: false,
    instructorCode: code,
    // ×œ×¦×•×¨×š TTL (×× ×ª×¤×¢×™×œ×™ ×‘×¢×ª×™×“):
    expiresAt: new Date(startTime + DAY_MS),
    updatedAt: serverTimestamp()
  }, { merge: true });

  barStatus.textContent = "×”×¤×¢×™×œ×•×ª ×”×•×¤×¢×œ×”";
});

// ---- × ×™×•×•×˜ ×‘×™×Ÿ ×©×œ×‘×™× ----
window.next = (n) => {
  if(n === 1) return showOnly('step1');
  if(n === 2) return showOnly('step2');
  if(n === 3) return showOnly('step3');
};

startBtn.addEventListener('click', () => {
  // ×× ×”×¡×©×Ÿ ×›×‘×¨ ×”×¡×ª×™×™× â€” ×œ× × ×ª×—×™×œ
  if(sessionEndsAt && Date.now() > sessionEndsAt){
    setStartEnabled(false);
    setLockedMessage(true);
    return;
  }
  showOnly('step1');
});

// ---- ×©××™×¨×ª ×ª×©×•×‘×•×ª ----
window.finish = async () => {
  // ×•×œ×™×“×¦×™×” ×¢×“×™× ×”
  if(!displayName.value.trim()){
    alert('×›×ª×‘×™ ×©× ×¤×¨×˜×™/×›×™× ×•×™ ×›×“×™ ×©×ª×•×›×œ×™ ×œ×–×”×•×ª ××ª ×¢×¦××š ×‘××¡×š ×”×—×™×‘×•×¨×™×.');
    return;
  }
  if(!mainDomain.value || !secondDomain.value || !workStyle.value || !teamStyle.value || !lifeInterest.value || !valuePlace.value){
    alert('×¨×§ ×¢×•×“ ×¨×’×¢ â€” ×”×©×œ×™××™ ××ª ×›×œ ×”×‘×—×™×¨×•×ª ×œ×¤× ×™ ×¡×™×•×.');
    return;
  }

  // ×× ×”×¡×©×Ÿ ×”×¡×ª×™×™× â€” ×œ× × ×©××•×¨
  if(sessionEndsAt && Date.now() > sessionEndsAt){
    showOnly('introScreen');
    setLockedMessage(true);
    return;
  }

  const payload = {
    sessionId: SESSION_ID,
    deviceId,
    displayName: displayName.value.trim(),
    mainDomain: mainDomain.value,
    secondDomain: secondDomain.value,
    workStyle: workStyle.value,
    teamStyle: teamStyle.value,
    lifeInterest: lifeInterest.value,
    valuePlace: valuePlace.value,
    createdAt: Date.now(),
    expiresAt: new Date(Date.now() + DAY_MS)
  };

  await setDoc(doc(responsesRef, crypto.randomUUID()), payload);
  showOnly('waiting');
};

// ---- ××œ×’×•×¨×™×ª× ×—×™×‘×•×¨×™× ----
function score(a, b){
  let s = 0;

  // 1) ×ª×—×•××™ ×¢× ×™×™×Ÿ ××©×•×ª×¤×™× (×—×–×§)
  if(a.mainDomain === b.mainDomain) s += 10;
  if(a.mainDomain === b.secondDomain) s += 6;
  if(b.mainDomain === a.secondDomain) s += 6;

  // 2) ×”×©×œ××” ×‘×¡×’× ×•×Ÿ ×¢×‘×•×“×” (×—×–×§)
  if(a.workStyle !== b.workStyle) s += 5;
  if(a.teamStyle !== b.teamStyle) s += 4;

  // 3) ×—×™×™×/×›×™×•×•×Ÿ (×‘×™× ×•× ×™)
  if(a.lifeInterest === b.lifeInterest) s += 2;
  if(a.valuePlace === b.valuePlace) s += 2;

  // 4) ×©×•×‘×¨ ×©×•×•×™×•×Ÿ ×“×˜×¨××™× ×™×¡×˜×™ (×›××¢×˜ ×‘×œ×ª×™ ××•×¨×’×©)
  const key = (a.displayName + '|' + b.displayName).split('').reduce((acc,ch)=>acc+ch.charCodeAt(0),0);
  s += (key % 7) * 0.01;

  return s;
}

function pickBestPairs(list){
  // ××œ×’×•×¨×™×ª× ×—××“× ×™: ×‘×›×œ ×¤×¢× ×‘×•×—×¨ ××ª ×”×¦××“ ×”×›×™ ×’×‘×•×” ×•××– ××¡×™×¨
  let students = [...list];
  let pairs = [];

  while(students.length > 1){
    let best = {i:-1,j:-1,sc:-Infinity};
    for(let i=0;i<students.length;i++){
      for(let j=i+1;j<students.length;j++){
        const sc = score(students[i], students[j]);
        if(sc > best.sc){
          best = {i,j,sc};
        }
      }
    }

    const a = students[best.i];
    const b = students[best.j];
    pairs.push({a,b,sc:best.sc});
    students = students.filter((_,idx)=>idx !== best.i && idx !== best.j);
  }

  // ×× × ×©××¨×” ××—×ª â€” ×©×œ×©×” ×¢× ×”×–×•×’ ×”×›×™ "×§×¨×•×‘" ××œ×™×”
  let trio = null;
  if(students.length === 1){
    const lone = students[0];
    let bestIdx = 0;
    let bestTrioScore = -Infinity;
    for(let k=0;k<pairs.length;k++){
      const t = score(lone, pairs[k].a) + score(lone, pairs[k].b);
      if(t > bestTrioScore){
        bestTrioScore = t;
        bestIdx = k;
      }
    }
    trio = { lone, withPairIndex: bestIdx };
  }

  return {pairs, trio};
}

async function showPairing(){
  // ×¡×™× ×•×Ÿ ×œ×¤×™ 24 ×©×¢×•×ª ×•×”×¡×©×Ÿ ×”× ×•×›×—×™
  const snap = await getDocs(responsesRef);
  const now = Date.now();
  const all = snap.docs.map(d => d.data());

  const students = all
    .filter(x => x.sessionId === SESSION_ID)
    .filter(x => typeof x.createdAt === 'number' && (now - x.createdAt) <= DAY_MS);

  if(students.length < 2){
    // ×¢×“×™×™×Ÿ ××™×Ÿ ××¡×¤×™×§
    return;
  }

  const {pairs, trio} = pickBestPairs(students);

  // ×ª×¦×•×’×”
  pairingResult.innerHTML = "";

  pairs.forEach((p, idx) => {
    const div = document.createElement('div');
    div.className = 'quote';
    div.innerHTML = `
      <strong>${p.a.displayName}</strong> â†” <strong>${p.b.displayName}</strong><br>
      <span style="opacity:.9">×ª×—×•×: ${p.a.mainDomain} Â· ${p.b.mainDomain}</span><br>
      <span style="opacity:.85">× ×‘×—×¨ ×œ×¤×™ ×ª×—×•××™ ×¢× ×™×™×Ÿ ××©×•×ª×¤×™× ×•×”×©×œ××” ×‘×¡×’× ×•×Ÿ ×¢×‘×•×“×”</span>
    `;
    pairingResult.appendChild(div);
  });

  if(trio && pairs[trio.withPairIndex]){
    const tDiv = document.createElement('div');
    tDiv.className = 'quote';
    const base = pairs[trio.withPairIndex];
    tDiv.innerHTML = `
      <strong>×©×œ×©×”</strong><br>
      ${base.a.displayName} Â· ${base.b.displayName} Â· ${trio.lone.displayName}<br>
      <span style="opacity:.85">×‘×›×™×ª×” ×¢× ××¡×¤×¨ ××™-×–×•×’×™ â€” × ×•×¦×¨×ª ×©×œ×©×” ××—×ª ×›×“×™ ×œ×©××•×¨ ×¢×œ ×©×•×ª×¤×•×ª ×œ×›×œ ××©×ª×ª×¤×ª.</span>
    `;
    pairingResult.appendChild(tDiv);
  }

  showOnly('pairing');
}

// ---- ×™×¦×™×¨×ª ×—×™×‘×•×¨×™× (××“×¨×™×›×”) ----
// ×›×“×™ ×©×”×—×™×‘×•×¨×™× ×™×•×¤×™×¢×• ×œ×›×•×œ×Ÿ: ×”××“×¨×™×›×” ××¤×¢×™×œ×” ×¡×™××•×Ÿ pairingReady.
// (××¤×©×¨ ×œ×œ×—×•×¥ ×¤×¢× ××—×ª ××—×¨×™ ×©×›×•×œ×Ÿ ×¡×™×™××• â€” ××• ×‘×¡×•×£ ×”×–××Ÿ)
// ×›××Ÿ ×‘×—×¨×ª×™: ×œ×—×™×¦×” × ×•×¡×¤×ª ×¢×œ "×”×ª×—×œ ×¤×¢×™×œ×•×ª" ×›×©×”×¤×¢×™×œ×•×ª ×¤×¢×™×œ×” = "×™×™×¦×¨×™ ×—×™×‘×•×¨×™×".
activateBtn.addEventListener('dblclick', async () => {
  // ×“××‘×œ-×§×œ×™×§ ×¢×“×™×Ÿ ×›×“×™ ×œ× ×œ×”×¤×¢×™×œ ×‘×˜×¢×•×ª
  const snap = await getDoc(sessionRef);
  if(!snap.exists()) return;
  const data = snap.data();
  if(!data.started || typeof data.startTime !== 'number') return;

  // ×× ×—×œ×£ ×”×–××Ÿ â€” ×œ× ××™×™×¦×¨×™×
  if(Date.now() > (data.startTime + SESSION_DURATION_MS)) return;

  await setDoc(sessionRef, {
    pairingReady: true,
    updatedAt: serverTimestamp()
  }, { merge: true });

  barStatus.textContent = "×”×—×™×‘×•×¨×™× × ×•×¦×¨×•";
});

// × ×™×•×•×˜ ×“×£ ×‘×™×ª (×”×ª××™××™ ××ª ×”×›×ª×•×‘×ª ××¦×œ×š)
window.goHome = () => {
  window.location.href = "../index.html";
};
</script>
</body>
</html>
