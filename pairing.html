<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>×¤×•×¨×¦×•×ª ×“×¨×š | ×—×™×‘×•×¨ ×œ×–×•×’×•×ª</title>

<style>
:root{
  --bg:#0f172a;
  --card:rgba(255,255,255,.08);
  --border:rgba(255,255,255,.18);
  --text:#f8fafc;
  --muted:#c7d2fe;
  --accent:#ec4899;
  --accent2:#6366f1;
  --radius:18px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,"Segoe UI",Arial;background:linear-gradient(145deg,#020617,#0f172a);color:var(--text)}
.container{max-width:760px;margin:auto;padding:22px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:18px}

/* LOCK (××¡×š ×›× ×™×¡×ª ××“×¨×™×›×” â€“ ×’×¨×¡×” ××•×§×˜× ×ª) */
#lock{
  max-width:360px;
  margin:70px auto 0;
  padding:16px 18px;
}
#lock h1{font-size:18px}
#lock p{font-size:13px}
#lock input{padding:10px;font-size:14px}
#lock button{margin-top:14px;padding:10px;font-size:14px}

h1{margin:0 0 8px;font-size:22px}
p{color:var(--muted);line-height:1.6;margin:0}
label{display:block;margin-top:14px;color:var(--muted)}
input,select{width:100%;padding:12px;margin-top:6px;border-radius:12px;border:1px solid var(--border);background:rgba(0,0,0,.25);color:var(--text)}

/* ×ª×™×‘×ª ××¡×¤×¨ ××©×ª×ª×¤×•×ª â€“ ×§×˜× ×” ×›××• ×§×•×“ ××“×¨×™×›×” */
.small-input{
  width:120px;
  padding:10px;
  font-size:14px;
}

button{width:100%;margin-top:18px;padding:13px;border:none;border-radius:14px;font-weight:600;cursor:pointer;color:white;background:linear-gradient(135deg,var(--accent),var(--accent2))}

/* ×›×¤×ª×•×¨ ×§×˜×Ÿ â€“ ×ª×•×× ×œ×©×“×•×ª ×”×§×˜× ×™× */
.small-btn{
  width:120px;
  padding:10px;
  font-size:14px;
  margin-top:12px;
}

button.secondary{background:transparent;border:1px solid var(--border)}
.hidden{display:none}
.group{padding:12px;border:1px solid var(--border);border-radius:14px;margin-top:10px;background:rgba(0,0,0,.25)}
.counter{font-size:18px;font-weight:600;margin-top:10px}

.notice{border:1px solid rgba(255,255,255,.22);background:rgba(0,0,0,.28);padding:12px;border-radius:14px}
.notice strong{display:block;margin-bottom:6px}
.notice a{color:var(--text)}
</style>
</head>

<body>
<div class="container">

  <!-- ERROR BANNER -->
  <div class="card hidden" id="errorBox">
    <div class="notice">
      <strong>×™×© ×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ××¡×“ (Firestore)</strong>
      <div id="errorMsg"></div>
    </div>
  </div>

  <!-- LOCK -->
  <div class="card" id="lock">
    <h1>×›× ×™×¡×ª ××“×¨×™×›×”</h1>
    <p>×”×–×™× ×™ ×§×•×“ ×›×“×™ ×œ×”××©×™×š</p>
    <input type="password" id="adminCode" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric" autocomplete="one-time-code">
    <button id="unlockBtn">×›× ×™×¡×”</button>
  </div>

  <!-- ADMIN -->
  <div class="card hidden" id="admin">
    <h1>× ×™×”×•×œ ×¤×¢×™×œ×•×ª</h1>
    <label for="expected">××¡×¤×¨ ××©×ª×ª×¤×•×ª</label>
    <input type="number" id="expected" value="18" min="2" class="small-input" inputmode="numeric">
    <button id="startSessionBtn" class="small-btn">×”×ª×—×œ ×¤×¢×™×œ×•×ª</button>
    <div class="counter" id="counter"></div>
    <button class="secondary hidden" id="generateBtn">×¦×•×¨ ×—×™×‘×•×¨×™×</button>
  </div>

  <!-- INTRO -->
  <div class="card hidden" id="intro">
    <h1>×‘×—×™×¨×ª ×©×•×ª×¤×” ×œ×ª×”×œ×™×š</h1>
    <p>×‘×¢×•×“ ×¨×’×¢ ×ª×ª×—×™×œ×™ ×©××œ×•×Ÿ ×§×¦×¨ ×©×™×¢×–×•×¨ ×œ× ×• ×œ×—×‘×¨ ×‘×™× ×™×›×Ÿ ×œ×–×•×’×•×ª ×¢×‘×•×“×”.</p>
    <button id="startQuizBtn">××ª×—×™×œ×•×ª</button>
  </div>

  <!-- QUIZ -->
  <div class="card hidden" id="quiz">
    <h1>×©××œ×•×Ÿ ×§×¦×¨</h1>
    <p>×¢× ×™ ×¢×œ ×”×©××œ×•×Ÿ. ×”×—×™×‘×•×¨ ×™×ª×‘×¦×¢ ××•×˜×•××˜×™×ª.</p>

    <label for="name">×©× ×¤×¨×˜×™</label>
    <input id="name" autocomplete="given-name">

    <label for="domain">×ª×—×•×</label>
    <select id="domain">
      <option value="">×‘×—×¨×™â€¦</option>
      <option>×”×™×™×˜×§ ×•×œ×™×‘×”</option>
      <option>××“× ×•×˜×›× ×•×œ×•×’×™×”</option>
      <option>×¡×‘×™×‘×” ×•×§×™×™××•×ª</option>
      <option>×¢×ª×™×“ ×•×™×–××•×ª</option>
      <option>×—×‘×¨×” ×•×“×™×’×™×˜×œ</option>
    </select>

    <label for="style">×¡×’× ×•×Ÿ ×¢×‘×•×“×”</label>
    <select id="style">
      <option value="">×‘×—×¨×™â€¦</option>
      <option>××ª×›× × ×ª ×•××– ××‘×¦×¢×ª</option>
      <option>×–×•×¨××ª ×•××– ××¡×“×¨×ª</option>
      <option>××“×‘×¨×ª ×•×—×•×©×‘×ª ×‘×§×•×œ</option>
      <option>×¢×•×‘×“×ª ×‘×©×§×˜ ×•××– ××©×ª×¤×ª</option>
    </select>

    <button id="submitBtn">×©×œ×™×—×”</button>
  </div>

  <!-- RESULT -->
  <div class="card hidden" id="result">
    <h1>×”×—×™×‘×•×¨×™×</h1>
    <div id="groups"></div>
    <button class="secondary" onclick="location.href='index.html'">×—×–×¨×” ×œ×“×£ ×”×‘×™×ª</button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  getDocs,
  enableIndexedDbPersistence
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ğŸ”´ ×¤×¨×˜×™ Firebase â€“ × ×›×•× ×™× ×œ-GitHub Pages (CDN)
const firebaseConfig = {
  apiKey: "AIzaSyCFSq5b-HgkTxFNhBJIBdOe2ian5TZvMPE",
  authDomain: "portzot-derech.firebaseapp.com",
  projectId: "portzot-derech"
};

const ADMIN_CODE = "2311";

// DOM helpers (×‘-module ××™×Ÿ ×’×™×©×” ××•×˜×•××˜×™×ª ×œ-id ×›××©×ª× ×™× ×’×œ×•×‘×œ×™×™×)
const $ = (id) => document.getElementById(id);

const errorBox = $("errorBox");
const errorMsg = $("errorMsg");

const lock = $("lock");
const admin = $("admin");
const intro = $("intro");
const quiz = $("quiz");
const result = $("result");

const adminCode = $("adminCode");
const unlockBtn = $("unlockBtn");

const expected = $("expected");
const startSessionBtn = $("startSessionBtn");
const counter = $("counter");
const generateBtn = $("generateBtn");

const startQuizBtn = $("startQuizBtn");

const nameInput = $("name");
const domainSel = $("domain");
const styleSel = $("style");
const submitBtn = $("submitBtn");

const groupsEl = $("groups");

function showError(userText, err){
  console.error(err);
  errorMsg.innerHTML = `${userText}${err?.message ? `<br><span style='opacity:.9'>${escapeHtml(err.message)}</span>` : ""}`;
  errorBox.classList.remove("hidden");
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// Init Firebase/Firestore
let db;
let responsesRef;
let unsub = null;
let expectedCount = 0;

try{
  // ×‘×“×™×§×•×ª ×§×•× ×¤×™×’×•×¨×¦×™×” ×‘×¡×™×¡×™×•×ª
  if(!firebaseConfig?.apiKey || !firebaseConfig?.authDomain || !firebaseConfig?.projectId){
    throw new Error("Firebase config ×—×¡×¨ (apiKey/authDomain/projectId)");
  }

  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);

  // ××•×¤×¦×™×•× ×œ×™: ×”×ª××“×” ××§×•××™×ª (×œ× ×—×•×‘×”; ××©×¤×¨ ×™×¦×™×‘×•×ª ×‘××•×‘×™×™×œ)
  enableIndexedDbPersistence(db).catch(()=>{});

  responsesRef = collection(db, "responses");
} catch (err){
  showError(
    "×œ× ×”×¦×œ×—×ª×™ ×œ××ª×—×œ ××ª Firestore. ×•×“××™ ×©×™×¦×¨×ª Firestore Database ×‘×¤×¨×•×™×§×˜ ×•×©××ª ××¨×™×¦×” ×“×¨×š HTTPS (GitHub Pages).",
    err
  );
}

// UI Logic
function unlock(){
  if(adminCode.value === ADMIN_CODE){
    lock.classList.add("hidden");
    admin.classList.remove("hidden");
  } else {
    alert("×§×•×“ ×©×’×•×™");
  }
}

function startSession(){
  if(!responsesRef) return;

  expectedCount = parseInt(expected.value || "0", 10);
  if(!Number.isFinite(expectedCount) || expectedCount < 2){
    return alert("×× × ×”×–×™× ×™ ××¡×¤×¨ ××©×ª×ª×¤×•×ª ×ª×§×™×Ÿ (2 ×•××¢×œ×”)");
  }

  counter.innerText = "×××ª×™× ×” ×œ×ª×©×•×‘×•×ªâ€¦";
  intro.classList.remove("hidden");

  // ×× ×œ×•×—×¦×™× ×©×•×‘ ×‘×˜×¢×•×ª â€“ ×œ× ×œ×”×•×¡×™×£ ×××–×™×Ÿ × ×•×¡×£
  if(typeof unsub === "function") unsub();

  unsub = onSnapshot(
    responsesRef,
    (snap)=>{
      counter.innerText = `× ×›× ×¡×• ${snap.size} ××ª×•×š ${expectedCount}`;
      if(snap.size >= expectedCount) generateBtn.classList.remove("hidden");
      else generateBtn.classList.add("hidden");
    },
    (err)=>{
      // ×©×’×™××” × ×¤×•×¦×”: Missing or insufficient permissions
      const hint = (err?.code === "permission-denied")
        ? "× ×¨××” ×©×”×”×¨×©××•×ª (Rules) ×©×œ Firestore ×œ× ×××¤×©×¨×•×ª ×§×¨×™××”/×›×ª×™×‘×”. ×•×“××™ ×©×”×ª×—×œ×ª ×‘-Test mode ××• ×¢×“×›× ×ª Rules."
        : "×‘×“×§×™ ×©×™×© Firestore Database ×¤×¢×™×œ ×•×©××ª ××—×•×‘×¨×ª ×œ××™× ×˜×¨× ×˜.";
      showError(`×”×—×™×‘×•×¨ ×œ-Firestore × ×›×©×œ. ${hint}` , err);
    }
  );
}

function startQuiz(){
  intro.classList.add("hidden");
  quiz.classList.remove("hidden");
}

async function submitResponse(){
  if(!responsesRef) return;

  if(!nameInput.value.trim() || !domainSel.value || !styleSel.value){
    return alert("×× × ××œ××™ ××ª ×›×œ ×”×©×“×•×ª");
  }

  try{
    await addDoc(responsesRef, {
      name: nameInput.value.trim(),
      domain: domainSel.value,
      style: styleSel.value,
      time: Date.now()
    });

    quiz.innerHTML = "<h1>×ª×•×“×” ğŸ™Œ</h1><p>×”×—×™×‘×•×¨ ××ª×‘×¦×¢ ×›×¢×ª.</p>";
  } catch (err){
    const hint = (err?.code === "permission-denied")
      ? "××™×Ÿ ×”×¨×©××•×ª ×›×ª×™×‘×” ×œ-Firestore (Rules)."
      : "×™×™×ª×›×Ÿ ×©××™×Ÿ ×—×™×‘×•×¨ ××™× ×˜×¨× ×˜ ××• ×©×™×© ×—×¡×™××” ×–×× ×™×ª.";
    showError(`×œ× ×”×¦×œ×—×ª×™ ×œ×©××•×¨ ××ª ×”×ª×©×•×‘×”. ${hint}`, err);
  }
}

async function generateGroups(){
  if(!responsesRef) return;

  try{
    const snap = await getDocs(responsesRef);
    const data = snap.docs.map(d=>d.data()).sort(()=>Math.random()-0.5);

    admin.classList.add("hidden");
    intro.classList.add("hidden");
    quiz.classList.add("hidden");
    result.classList.remove("hidden");

    groupsEl.innerHTML = "";

    if(data.length % 2 === 1){
      renderGroup(data.splice(0,3), "×©×œ×©×”");
    }
    while(data.length){
      renderGroup(data.splice(0,2), "×–×•×’");
    }
  } catch (err){
    showError("×œ× ×”×¦×œ×—×ª×™ ×œ×§×¨×•× ×ª×©×•×‘×•×ª ×-Firestore ×›×“×™ ×œ×™×¦×•×¨ ×—×™×‘×•×¨×™×.", err);
  }
}

function renderGroup(arr, type){
  const div = document.createElement("div");
  div.className = "group";
  div.innerHTML = `<strong>${type}</strong><br>${arr.map(a=>escapeHtml(a.name)).join(" + ")}<br><span style='color:var(--muted)'>×ª×—×•×: ${escapeHtml(arr?.[0]?.domain || "")}</span>`;
  groupsEl.appendChild(div);
}

// Events
unlockBtn.addEventListener("click", unlock);
adminCode.addEventListener("keydown", (e)=>{ if(e.key === "Enter") unlock(); });
startSessionBtn.addEventListener("click", startSession);
generateBtn.addEventListener("click", generateGroups);
startQuizBtn.addEventListener("click", startQuiz);
submitBtn.addEventListener("click", submitResponse);

// --- Self-tests (×¨×§ ×›×©×¤×•×ª×—×™× ×¢× ?test=1) ---
function assert(cond, msg){ if(!cond) throw new Error(`TEST FAILED: ${msg}`); }
function runSelfTests(){
  assert(typeof unlock === "function", "unlock() exists");
  assert(typeof startSession === "function", "startSession() exists");
  assert(typeof startQuiz === "function", "startQuiz() exists");
  assert(typeof submitResponse === "function", "submitResponse() exists");
  assert(typeof generateGroups === "function", "generateGroups() exists");
  assert(!!lock && !!admin && !!intro && !!quiz && !!result, "core screens exist");
  assert(!!responsesRef, "responsesRef initialized");
  console.log("All tests passed âœ…");
}
if(new URLSearchParams(location.search).get("test") === "1"){
  try{ runSelfTests(); } catch(e){ console.error(e); showError("×‘×“×™×§×•×ª ×¤× ×™××™×•×ª × ×›×©×œ×•.", e); }
}
</script>
</body>
</html>
